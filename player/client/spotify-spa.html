<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Spotify</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'spotify-circular';
            src: local('Circular Std'), local('Helvetica Neue'), local('Helvetica'), local('Arial'), sans-serif;
        }

        body {
            font-family: spotify-circular, Helvetica Neue, Helvetica, Arial, sans-serif;
            background: #121212;
            color: #fff;
            overflow: hidden;
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 1fr 90px;
            grid-template-areas:
                "sidebar main"
                "nowplaying nowplaying";
            height: 100vh;
            cursor: none;
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: #000;
            padding: 24px 24px 0;
            overflow-y: auto;
        }

        .logo {
            margin-bottom: 24px;
            height: 40px;
        }

        .logo svg {
            height: 100%;
            fill: #fff;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 0;
            color: #b3b3b3;
            text-decoration: none;
            transition: color 0.2s;
            cursor: pointer;
        }

        .nav-item:hover {
            color: #fff;
        }

        .nav-item.active {
            color: #fff;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .library-section {
            border-top: 1px solid #282828;
            padding-top: 8px;
        }

        .library-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            color: #b3b3b3;
        }

        .playlists {
            margin-top: 8px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .playlist-item:hover {
            background: #1a1a1a;
        }

        .playlist-cover {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        .playlist-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .playlist-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-name {
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-type {
            font-size: 12px;
            color: #b3b3b3;
            margin-top: 4px;
        }

        /* Main View */
        .main-view {
            grid-area: main;
            background: linear-gradient(to bottom, #1f1f1f 0%, #121212 100%);
            overflow-y: auto;
            position: relative;
        }

        .top-bar {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .nav-buttons {
            display: flex;
            gap: 16px;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #fff;
            cursor: pointer;
        }

        .search-bar {
            display: none;
            position: relative;
            width: 364px;
        }

        .search-bar.active {
            display: block;
        }

        .search-input {
            width: 100%;
            height: 40px;
            padding: 6px 48px;
            border-radius: 500px;
            border: none;
            background: #fff;
            color: #000;
            font-size: 14px;
        }

        .main-content {
            padding: 24px 32px 32px;
        }

        /* Now Playing Bar */
        .now-playing {
            grid-area: nowplaying;
            background: #181818;
            border-top: 1px solid #282828;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .now-playing-left {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 180px;
            width: 30%;
        }

        .now-playing-cover {
            width: 56px;
            height: 56px;
        }

        .now-playing-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .now-playing-info {
            min-width: 0;
        }

        .now-playing-title {
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .now-playing-artist {
            font-size: 11px;
            color: #b3b3b3;
            margin-top: 4px;
        }

        .now-playing-center {
            max-width: 722px;
            width: 40%;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .control-button {
            background: transparent;
            border: none;
            color: #b3b3b3;
            cursor: pointer;
            padding: 0;
            transition: color 0.2s;
        }

        .control-button:hover {
            color: #fff;
        }

        .control-button.active {
            color: #1db954;
        }

        .control-button .icon {
            width: 16px;
            height: 16px;
        }

        .play-pause-btn {
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 50%;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-pause-btn:hover {
            transform: scale(1.06);
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time {
            font-size: 11px;
            color: #b3b3b3;
            min-width: 40px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #4d4d4d;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            position: relative;
            transition: width 0.1s linear;
        }

        .progress-bar:hover .progress-fill {
            background: #1db954;
        }

        .now-playing-right {
            min-width: 180px;
            width: 30%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 125px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: #4d4d4d;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
        }

        /* Content Styles */
        .content-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        .card {
            background: #181818;
            border-radius: 4px;
            padding: 16px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .card:hover {
            background: #282828;
        }

        .card-image {
            position: relative;
            padding-bottom: 100%;
            margin-bottom: 16px;
        }

        .card-image img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .play-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 48px;
            height: 48px;
            background: #1db954;
            border-radius: 50%;
            border: none;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s;
        }

        .card:hover .play-button {
            opacity: 1;
            transform: translateY(0);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 14px;
            color: #b3b3b3;
        }

        /* Playlist View */
        .playlist-header {
            display: flex;
            align-items: end;
            gap: 24px;
            padding: 24px 32px;
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
        }

        .playlist-cover-large {
            width: 232px;
            height: 232px;
            flex-shrink: 0;
        }

        .playlist-cover-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-info-header {
            flex: 1;
        }

        .playlist-type-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .playlist-title {
            font-size: 48px;
            font-weight: 900;
            margin: 0 0 8px 0;
            line-height: 1.1;
        }

        .playlist-description {
            color: #b3b3b3;
            margin: 8px 0;
        }

        .playlist-stats {
            margin-top: 16px;
            color: #b3b3b3;
        }

        .playlist-controls {
            padding: 24px 32px;
        }

        .playlist-controls button {
            margin-right: 24px;
        }

        .btn-primary {
            background: #1db954;
            color: #000;
            border: none;
            border-radius: 500px;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #b3b3b3;
            border-radius: 500px;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .track-list-header {
            display: grid;
            grid-template-columns: 16px 4fr 2fr 1fr;
            gap: 16px;
            padding: 8px 48px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #b3b3b3;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .track-list {
            padding: 0 32px;
        }

        .track-row {
            display: grid;
            grid-template-columns: 16px 4fr 2fr 1fr;
            gap: 16px;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .track-row:hover {
            background: rgba(255,255,255,0.1);
        }

        .track-number {
            color: #b3b3b3;
            display: flex;
            align-items: center;
        }

        .track-main {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .track-cover {
            width: 40px;
            height: 40px;
        }

        .track-cover img {
            width: 100%;
            height: 100%;
        }

        .track-info {
            min-width: 0;
        }

        .track-name {
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artists {
            color: #b3b3b3;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-album {
            color: #b3b3b3;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration {
            color: #b3b3b3;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* Hide scrollbars */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #4d4d4d;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #606060;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <svg viewBox="0 0 1134 340">
                <path d="M8 171c0 92 76 168 168 168s168-76 168-168S268 4 176 4 8 79 8 171zm230 78c-39-24-89-30-147-17-14 2-16-18-4-20 64-15 118-8 162 19 11 7 0 24-11 18zm17-45c-45-28-114-36-167-20-17 5-23-21-7-25 61-18 136-9 188 23 14 9 0 31-14 22zM80 133c-17 6-28-23-9-30 59-18 159-15 221 22 17 9 1 37-17 27-54-32-144-35-195-19zm379 91c-17 0-33-6-47-20-1 0-1 1-1 1l-16 19c-1 1-1 2 0 3 18 16 40 24 64 24 34 0 55-19 55-47 0-24-15-37-50-46-29-7-34-12-34-22s10-16 23-16 25 5 39 15c0 0 1 1 2 1s1-1 1-1l14-20c1-1 1-1 0-2-16-13-35-20-56-20-31 0-53 19-53 46 0 29 20 38 52 46 28 6 32 12 32 22 0 11-10 17-25 17zm95-77v-13c0-1-1-2-2-2h-26c-1 0-2 1-2 2v147c0 1 1 2 2 2h26c1 0 2-1 2-2v-46c10 11 21 16 36 16 27 0 54-21 54-61s-27-60-54-60c-15 0-26 5-36 17zm30 78c-18 0-31-15-31-35s13-34 31-34 30 14 30 34-12 35-30 35zm68-34c0 34 27 60 62 60s62-27 62-61-26-60-61-60-63 27-63 61zm30-1c0-20 13-34 32-34s33 15 33 35-13 34-32 34-33-15-33-35zm140-58v-29c0-1 0-2-1-2h-26c-1 0-2 1-2 2v29h-13c-1 0-2 1-2 2v22c0 1 1 2 2 2h13v58c0 23 11 35 34 35 9 0 18-2 25-6 1 0 1-1 1-2v-21c0-1 0-2-1-2h-2c-5 3-11 4-16 4-8 0-12-4-12-12v-54h30c1 0 2-1 2-2v-22c0-1-1-2-2-2h-30zm129-3c0-11 4-15 13-15 5 0 10 0 15 2h1s1-1 1-2V93c0-1 0-2-1-2-5-2-12-3-22-3-24 0-36 14-36 39v5h-13c-1 0-2 1-2 2v22c0 1 1 2 2 2h13v89c0 1 1 2 2 2h26c1 0 1-1 1-2v-89h25l37 89c-4 9-8 11-14 11-5 0-10-1-15-4h-1l-1 1-9 19c0 1 0 2 1 2 9 5 17 7 27 7 19 0 30-9 39-33l45-116v-2c0-1-1-1-2-1h-27c-1 0-1 1-1 2l-28 78-30-78c0-1-1-2-2-2h-44v-3zm-83 3c-1 0-2 1-2 2v113c0 1 1 2 2 2h26c1 0 1-1 1-2V134c0-1 0-2-1-2h-26zm-6-33c0 10 9 19 19 19s18-9 18-19-8-18-18-18-19 8-19 18zm245 69c10 0 19-8 19-18s-9-18-19-18-18 8-18 18 8 18 18 18zm0-34c9 0 17 7 17 16s-8 16-17 16-16-7-16-16 7-16 16-16zm4 18c3-1 5-3 5-6 0-4-4-6-8-6h-8v19h4v-6h4l4 6h5zm-3-9c2 0 4 1 4 3s-2 3-4 3h-4v-6h4z"/>
            </svg>
        </div>
        
        <nav class="nav-section">
            <div class="nav-item active" data-page="home">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12.5 3.247a1 1 0 00-1 0L4 7.577V20h4.5v-6a1 1 0 011-1h5a1 1 0 011 1v6H20V7.577l-7.5-4.33zm-2-1.732a3 3 0 013 0l7.5 4.33a2 2 0 011 1.732V21a1 1 0 01-1 1h-6.5a1 1 0 01-1-1v-6h-3v6a1 1 0 01-1 1H3a1 1 0 01-1-1V7.577a2 2 0 011-1.732l7.5-4.33z"/>
                </svg>
                <span>Home</span>
            </div>
            <div class="nav-item" data-page="search">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"/>
                </svg>
                <span>Search</span>
            </div>
        </nav>
        
        <div class="library-section">
            <div class="library-header">
                <span>Your Library</span>
            </div>
            <div class="playlists" id="playlists"></div>
        </div>
    </aside>

    <!-- Main View -->
    <main class="main-view">
        <div class="top-bar">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="history.back()" disabled>
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor" d="M11.03.47a.75.75 0 010 1.06L4.56 8l6.47 6.47a.75.75 0 11-1.06 1.06L2.44 8 9.97.47a.75.75 0 011.06 0z"/>
                    </svg>
                </button>
                <button class="nav-btn" onclick="history.forward()" disabled>
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor" d="M4.97.47a.75.75 0 000 1.06L11.44 8l-6.47 6.47a.75.75 0 101.06 1.06L13.56 8 6.03.47a.75.75 0 00-1.06 0z"/>
                    </svg>
                </button>
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="What do you want to listen to?">
            </div>
        </div>
        
        <div class="main-content" id="mainContent"></div>
    </main>

    <!-- Now Playing Bar -->
    <footer class="now-playing">
        <div class="now-playing-left">
            <div class="now-playing-cover" id="nowPlayingCover"></div>
            <div class="now-playing-info">
                <div class="now-playing-title" id="nowPlayingTitle">-</div>
                <div class="now-playing-artist" id="nowPlayingArtist">-</div>
            </div>
            <button class="control-button" id="likeBtn">
                <svg class="icon" viewBox="0 0 16 16">
                    <path fill="currentColor" d="M1.69 2A4.582 4.582 0 018 2.023 4.583 4.583 0 0111.88.817h.002a4.618 4.618 0 013.782 3.65v.003a4.543 4.543 0 01-1.011 3.84L9.35 14.629a1.765 1.765 0 01-2.093.464 1.762 1.762 0 01-.605-.463L1.348 8.309A4.582 4.582 0 011.689 2zm3.158.252A3.082 3.082 0 002.49 7.337l.005.005L7.8 13.664a.264.264 0 00.311.069.262.262 0 00.09-.069l5.312-6.33a3.043 3.043 0 00.68-2.573 3.118 3.118 0 00-2.551-2.463 3.079 3.079 0 00-2.612.816l-.007.007a1.501 1.501 0 01-2.045 0l-.009-.008a3.082 3.082 0 00-2.121-.861z"/>
                </svg>
            </button>
        </div>
        
        <div class="now-playing-center">
            <div class="player-controls">
                <button class="control-button" id="shuffleBtn">
                    <svg class="icon" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M13.151.922a.75.75 0 10-1.06 1.06L13.109 3H11.16a3.75 3.75 0 00-2.873 1.34l-6.173 7.356A2.25 2.25 0 01.39 12.5H0V14h.391a3.75 3.75 0 002.873-1.34l6.173-7.356a2.25 2.25 0 011.724-.804h1.947l-1.017 1.018a.75.75 0 001.06 1.06L15.98 3.75 13.15.922zM.391 3.5H0V2h.391c1.109 0 2.16.49 2.873 1.34L4.89 5.277l-.979 1.167-1.796-2.14A2.25 2.25 0 00.39 3.5z"/>
                        <path fill="currentColor" d="M7.5 10.723l.98-1.167.957 1.14a2.25 2.25 0 001.724.804h1.947l-1.017-1.018a.75.75 0 111.06-1.06l2.829 2.828-2.829 2.828a.75.75 0 11-1.06-1.06L13.109 13H11.16a3.75 3.75 0 01-2.873-1.34l-.787-.938z"/>
                    </svg>
                </button>
                
                <button class="control-button" id="prevBtn">
                    <svg class="icon" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M3.3 1a.7.7 0 01.7.7v5.15l9.95-5.744a.7.7 0 011.05.606v12.575a.7.7 0 01-1.05.607L4 9.149V14.3a.7.7 0 01-.7.7H1.7a.7.7 0 01-.7-.7V1.7a.7.7 0 01.7-.7h1.6z"/>
                    </svg>
                </button>
                
                <button class="control-button play-pause-btn" id="playPauseBtn">
                    <svg class="icon" viewBox="0 0 16 16" id="playIcon">
                        <path fill="currentColor" d="M3 1.713a.7.7 0 011.05-.607l10.89 6.288a.7.7 0 010 1.212L4.05 14.894A.7.7 0 013 14.288V1.713z"/>
                    </svg>
                    <svg class="icon" viewBox="0 0 16 16" id="pauseIcon" style="display: none;">
                        <path fill="currentColor" d="M2.7 1a.7.7 0 00-.7.7v12.6a.7.7 0 00.7.7h2.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7H2.7zm8 0a.7.7 0 00-.7.7v12.6a.7.7 0 00.7.7h2.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-2.6z"/>
                    </svg>
                </button>
                
                <button class="control-button" id="nextBtn">
                    <svg class="icon" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M12.7 1a.7.7 0 00-.7.7v5.15L2.05 1.107A.7.7 0 001 1.712v12.575a.7.7 0 001.05.607L12 9.149V14.3a.7.7 0 00.7.7h1.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-1.6z"/>
                    </svg>
                </button>
                
                <button class="control-button" id="repeatBtn">
                    <svg class="icon" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M0 4.75A3.75 3.75 0 013.75 1h8.5A3.75 3.75 0 0116 4.75v5a3.75 3.75 0 01-3.75 3.75H9.81l1.018 1.018a.75.75 0 11-1.06 1.06L6.939 12.75l2.829-2.828a.75.75 0 111.06 1.06L9.811 12h2.439a2.25 2.25 0 002.25-2.25v-5a2.25 2.25 0 00-2.25-2.25h-8.5A2.25 2.25 0 001.5 4.75v5A2.25 2.25 0 003.75 12H5v1.5H3.75A3.75 3.75 0 010 9.75v-5z"/>
                    </svg>
                </button>
            </div>
            
            <div class="progress-container">
                <span class="time" id="currentTime">0:00</span>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="time" id="duration">0:00</span>
            </div>
        </div>
        
        <div class="now-playing-right">
            <div class="volume-container">
                <svg width="16" height="16" viewBox="0 0 16 16">
                    <path fill="currentColor" d="M9.741.85a.75.75 0 01.375.65v13a.75.75 0 01-1.125.65l-6.925-4a3.642 3.642 0 01-1.33-4.967 3.639 3.639 0 011.33-.983l6.925-4a.75.75 0 01.75 0zm-6.924 5.3a2.139 2.139 0 000 3.7l5.8 3.35V2.8l-5.8 3.35zm8.683 4.29V5.56a2.75 2.75 0 010 4.88z"/>
                    <path fill="currentColor" d="M11.5 13.614a5.752 5.752 0 000-11.228v1.55a4.252 4.252 0 010 8.127v1.55z"/>
                </svg>
                <div class="volume-slider" id="volumeSlider">
                    <div class="volume-fill" id="volumeFill"></div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Application State - SINGLE SOURCE OF TRUTH
        const AppState = {
            currentView: 'home',
            playlists: [],
            currentPlaylist: null,
            currentTrack: null,
            isPlaying: false,
            shuffleState: false,
            repeatState: 'off',
            isLiked: false,
            volume: 50,
            currentTime: 0,
            duration: 0,
            searchResults: null
        };

        // DOM Element Cache - NEVER RE-QUERY
        const DOM = {
            // Sidebar
            playlists: document.getElementById('playlists'),
            navItems: document.querySelectorAll('.nav-item'),
            
            // Main Content
            mainContent: document.getElementById('mainContent'),
            searchBar: document.querySelector('.search-bar'),
            searchInput: document.getElementById('searchInput'),
            
            // Now Playing
            nowPlayingCover: document.getElementById('nowPlayingCover'),
            nowPlayingTitle: document.getElementById('nowPlayingTitle'),
            nowPlayingArtist: document.getElementById('nowPlayingArtist'),
            
            // Controls
            playPauseBtn: document.getElementById('playPauseBtn'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            shuffleBtn: document.getElementById('shuffleBtn'),
            repeatBtn: document.getElementById('repeatBtn'),
            likeBtn: document.getElementById('likeBtn'),
            
            // Progress
            currentTime: document.getElementById('currentTime'),
            duration: document.getElementById('duration'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            
            // Volume
            volumeSlider: document.getElementById('volumeSlider'),
            volumeFill: document.getElementById('volumeFill')
        };

        // API Layer - All server communication
        const API = {
            async request(endpoint, method = 'GET', body = null) {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                
                try {
                    const response = await fetch(`/api${endpoint}`, options);
                    return response.ok ? await response.json() : null;
                } catch (error) {
                    console.error('API error:', error);
                    return null;
                }
            },
            
            // Playback
            play: (options) => API.request('/play', 'POST', options),
            pause: () => API.request('/pause', 'POST'),
            next: () => API.request('/next', 'POST'),
            previous: () => API.request('/previous', 'POST'),
            seek: (position_ms) => API.request('/seek', 'POST', { position_ms }),
            
            // Controls
            shuffle: (state) => API.request('/shuffle', 'POST', { state }),
            repeat: (state) => API.request('/repeat', 'POST', { state }),
            volume: (volume) => API.request('/volume', 'POST', { volume }),
            like: (track_id, liked) => API.request('/like', 'POST', { track_id, liked }),
            
            // Data
            getPlayback: () => API.request('/playback'),
            getPlaylists: () => API.request('/playlists'),
            getPlaylist: (id) => API.request(`/playlist/${id}`),
            search: (query) => API.request('/search', 'POST', { query })
        };

        // View Renderer - Updates ONLY what changed
        const Renderer = {
            updatePlayButton() {
                DOM.playIcon.style.display = AppState.isPlaying ? 'none' : 'block';
                DOM.pauseIcon.style.display = AppState.isPlaying ? 'block' : 'none';
            },
            
            updateNowPlaying() {
                const track = AppState.currentTrack;
                if (!track) return;
                
                // Only update if changed
                if (DOM.nowPlayingTitle.textContent !== track.name) {
                    DOM.nowPlayingTitle.textContent = track.name;
                }
                
                const artist = track.artists?.map(a => a.name).join(', ') || '-';
                if (DOM.nowPlayingArtist.textContent !== artist) {
                    DOM.nowPlayingArtist.textContent = artist;
                }
                
                const coverUrl = track.album?.images?.[0]?.url;
                if (coverUrl && !DOM.nowPlayingCover.querySelector(`img[src="${coverUrl}"]`)) {
                    DOM.nowPlayingCover.innerHTML = `<img src="${coverUrl}" alt="">`;
                }
            },
            
            updateProgress() {
                const percent = AppState.duration > 0 ? (AppState.currentTime / AppState.duration) * 100 : 0;
                DOM.progressFill.style.width = percent + '%';
                DOM.currentTime.textContent = this.formatTime(AppState.currentTime);
                DOM.duration.textContent = this.formatTime(AppState.duration);
            },
            
            updateControls() {
                DOM.shuffleBtn.classList.toggle('active', AppState.shuffleState);
                DOM.repeatBtn.classList.toggle('active', AppState.repeatState !== 'off');
                DOM.likeBtn.classList.toggle('active', AppState.isLiked);
                DOM.volumeFill.style.width = AppState.volume + '%';
            },
            
            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            },
            
            renderPlaylists() {
                // Only render if playlists changed
                const html = AppState.playlists.map(p => `
                    <div class="playlist-item" data-id="${p.id}" data-uri="${p.uri}">
                        <div class="playlist-cover">
                            ${p.images?.[0]?.url ? 
                                `<img src="${p.images[0].url}" alt="">` : 
                                '<div style="background: #282828; width: 100%; height: 100%;"></div>'
                            }
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-name">${p.name}</div>
                            <div class="playlist-type">${p.type === 'collection' ? 'Liked Songs' : 'Playlist'}</div>
                        </div>
                    </div>
                `).join('');
                
                if (DOM.playlists.innerHTML !== html) {
                    DOM.playlists.innerHTML = html;
                    this.attachPlaylistHandlers();
                }
            },
            
            attachPlaylistHandlers() {
                DOM.playlists.querySelectorAll('.playlist-item').forEach(item => {
                    item.onclick = () => Views.loadPlaylist(item.dataset.id, item.dataset.uri);
                });
            }
        };

        // View Controllers - Handle different pages
        const Views = {
            home() {
                if (AppState.currentView === 'home') return;
                AppState.currentView = 'home';
                
                DOM.mainContent.innerHTML = `
                    <div class="content-section">
                        <h2 class="section-title">Good ${this.getGreeting()}</h2>
                        <div class="cards-grid" id="homeCards"></div>
                    </div>
                `;
                
                this.renderHomeCards();
            },
            
            renderHomeCards() {
                const container = document.getElementById('homeCards');
                if (!container) return;
                
                container.innerHTML = AppState.playlists.slice(0, 6).map(p => `
                    <div class="card" data-id="${p.id}" data-uri="${p.uri}">
                        <div class="card-image">
                            ${p.images?.[0]?.url ? 
                                `<img src="${p.images[0].url}" alt="">` : 
                                '<div style="background: #282828; width: 100%; height: 100%;"></div>'
                            }
                            <button class="play-button" data-uri="${p.uri}">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M7.05 3.606l13.49 7.788a.7.7 0 010 1.212L7.05 20.394A.7.7 0 016 19.788V4.212a.7.7 0 011.05-.606z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="card-title">${p.name}</div>
                        <div class="card-subtitle">Playlist</div>
                    </div>
                `).join('');
                
                // Attach handlers
                container.querySelectorAll('.card').forEach(card => {
                    card.onclick = (e) => {
                        if (e.target.closest('.play-button')) {
                            API.play({ context_uri: card.dataset.uri });
                        } else {
                            this.loadPlaylist(card.dataset.id, card.dataset.uri);
                        }
                    };
                });
            },
            
            async loadPlaylist(id, uri) {
                AppState.currentView = 'playlist';
                
                // Show loading
                DOM.mainContent.innerHTML = '<div style="padding: 40px; text-align: center;">Loading...</div>';
                
                const playlist = await API.getPlaylist(id);
                if (!playlist) return;
                
                AppState.currentPlaylist = playlist;
                this.renderPlaylist(playlist, uri);
            },
            
            renderPlaylist(playlist, uri) {
                DOM.mainContent.innerHTML = `
                    <div class="playlist-header">
                        <div class="playlist-cover-large">
                            ${playlist.image ? 
                                `<img src="${playlist.image}" alt="">` :
                                `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #450af5, #c4eeff);"></div>`
                            }
                        </div>
                        <div class="playlist-info-header">
                            <div class="playlist-type-label">PLAYLIST</div>
                            <h1 class="playlist-title">${playlist.name}</h1>
                            ${playlist.description ? `<p class="playlist-description">${playlist.description}</p>` : ''}
                            <div class="playlist-stats">${playlist.total || playlist.tracks.length} songs</div>
                        </div>
                    </div>
                    
                    <div class="playlist-controls">
                        <button class="btn-primary" data-uri="${uri}">Play</button>
                        <button class="btn-secondary" data-uri="${uri}">Shuffle</button>
                    </div>
                    
                    <div class="track-list-header">
                        <div>#</div>
                        <div>Title</div>
                        <div>Album</div>
                        <div style="text-align: right;">Duration</div>
                    </div>
                    
                    <div class="track-list" id="trackList"></div>
                `;
                
                // Render tracks
                const trackList = document.getElementById('trackList');
                trackList.innerHTML = playlist.tracks.map((track, i) => `
                    <div class="track-row" data-index="${i}" data-uri="${uri}">
                        <div class="track-number">${i + 1}</div>
                        <div class="track-main">
                            ${track.image ? 
                                `<div class="track-cover"><img src="${track.image}" alt=""></div>` : 
                                '<div class="track-cover" style="background: #282828;"></div>'
                            }
                            <div class="track-info">
                                <div class="track-name">${track.name}</div>
                                <div class="track-artists">${track.artists}</div>
                            </div>
                        </div>
                        <div class="track-album">${track.album}</div>
                        <div class="track-duration">${Renderer.formatTime(track.duration_ms)}</div>
                    </div>
                `).join('');
                
                // Attach handlers
                document.querySelector('.btn-primary').onclick = () => API.play({ context_uri: uri });
                document.querySelector('.btn-secondary').onclick = async () => {
                    await API.shuffle('on');
                    await API.play({ context_uri: uri });
                };
                
                trackList.querySelectorAll('.track-row').forEach(row => {
                    row.onclick = () => API.play({ 
                        context_uri: row.dataset.uri,
                        offset: { position: parseInt(row.dataset.index) }
                    });
                });
            },
            
            search() {
                if (AppState.currentView === 'search') return;
                AppState.currentView = 'search';
                DOM.searchBar.classList.add('active');
                DOM.searchInput.focus();
            },
            
            getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'morning';
                if (hour < 18) return 'afternoon';
                return 'evening';
            }
        };

        // WebSocket for real-time updates
        class RealtimeUpdates {
            constructor() {
                this.ws = null;
                this.reconnectTimer = null;
            }
            
            connect() {
                if (this.ws?.readyState === WebSocket.OPEN) return;
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${window.location.host}`);
                
                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'playback') {
                            this.updatePlayback(message.data);
                        }
                    } catch (e) {
                        console.error('WebSocket error:', e);
                    }
                };
                
                this.ws.onerror = this.ws.onclose = () => {
                    this.ws = null;
                    clearTimeout(this.reconnectTimer);
                    this.reconnectTimer = setTimeout(() => this.connect(), 5000);
                };
            }
            
            updatePlayback(data) {
                if (!data) return;
                
                // Only update what changed
                if (data.is_playing !== AppState.isPlaying) {
                    AppState.isPlaying = data.is_playing;
                    Renderer.updatePlayButton();
                }
                
                if (data.item && (!AppState.currentTrack || AppState.currentTrack.id !== data.item.id)) {
                    AppState.currentTrack = data.item;
                    Renderer.updateNowPlaying();
                }
                
                if (data.progress_ms !== undefined) {
                    AppState.currentTime = data.progress_ms;
                    AppState.duration = data.item?.duration_ms || 0;
                    Renderer.updateProgress();
                }
                
                if (data.shuffle_state !== AppState.shuffleState) {
                    AppState.shuffleState = data.shuffle_state;
                }
                
                if (data.repeat_state !== AppState.repeatState) {
                    AppState.repeatState = data.repeat_state;
                }
                
                if (data.is_liked !== AppState.isLiked) {
                    AppState.isLiked = data.is_liked;
                }
                
                if (data.device?.volume_percent !== AppState.volume) {
                    AppState.volume = data.device.volume_percent;
                }
                
                Renderer.updateControls();
            }
        }

        // Event Handlers - Attach once, never re-attach
        function attachEventHandlers() {
            // Navigation
            DOM.navItems.forEach(item => {
                item.onclick = () => {
                    DOM.navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    const page = item.dataset.page;
                    if (page === 'search') {
                        Views.search();
                    } else {
                        DOM.searchBar.classList.remove('active');
                        Views.home();
                    }
                };
            });
            
            // Playback controls
            DOM.playPauseBtn.onclick = () => {
                AppState.isPlaying ? API.pause() : API.play();
            };
            
            DOM.prevBtn.onclick = () => API.previous();
            DOM.nextBtn.onclick = () => API.next();
            
            DOM.shuffleBtn.onclick = () => {
                API.shuffle(AppState.shuffleState ? 'off' : 'on');
            };
            
            DOM.repeatBtn.onclick = () => {
                const states = ['off', 'context', 'track'];
                const current = states.indexOf(AppState.repeatState);
                API.repeat(states[(current + 1) % states.length]);
            };
            
            DOM.likeBtn.onclick = () => {
                if (AppState.currentTrack) {
                    API.like(AppState.currentTrack.id, !AppState.isLiked);
                }
            };
            
            // Progress seeking
            DOM.progressBar.onclick = (e) => {
                const rect = DOM.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const position = Math.round(percent * AppState.duration);
                API.seek(position);
            };
            
            // Volume
            DOM.volumeSlider.onclick = (e) => {
                const rect = DOM.volumeSlider.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const volume = Math.round(percent * 100);
                API.volume(volume);
            };
            
            // Search
            let searchTimer;
            DOM.searchInput.oninput = (e) => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(async () => {
                    if (e.target.value.length > 1) {
                        const results = await API.search(e.target.value);
                        if (results) {
                            renderSearchResults(results.results);
                        }
                    }
                }, 300);
            };
        }

        function renderSearchResults(results) {
            DOM.mainContent.innerHTML = `
                <div class="content-section">
                    <h2 class="section-title">Search Results</h2>
                    <div class="cards-grid" id="searchCards"></div>
                </div>
            `;
            
            const container = document.getElementById('searchCards');
            container.innerHTML = results.map(item => `
                <div class="card" data-uri="${item.uri}" data-type="${item.type}">
                    <div class="card-image">
                        ${item.image ? 
                            `<img src="${item.image}" alt="">` : 
                            '<div style="background: #282828; width: 100%; height: 100%;"></div>'
                        }
                        <button class="play-button">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M7.05 3.606l13.49 7.788a.7.7 0 010 1.212L7.05 20.394A.7.7 0 016 19.788V4.212a.7.7 0 011.05-.606z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="card-title">${item.name}</div>
                    <div class="card-subtitle">${item.artist || item.owner || ''}</div>
                </div>
            `).join('');
            
            container.querySelectorAll('.card').forEach(card => {
                card.onclick = (e) => {
                    const uri = card.dataset.uri;
                    const type = card.dataset.type;
                    
                    if (e.target.closest('.play-button') || type === 'track') {
                        API.play(type === 'track' ? { uris: [uri] } : { context_uri: uri });
                    } else if (type === 'playlist') {
                        const id = uri.split(':').pop();
                        Views.loadPlaylist(id, uri);
                    }
                };
            });
        }

        // Progress animation
        function animateProgress() {
            if (AppState.isPlaying && AppState.duration > 0) {
                AppState.currentTime += 100;
                if (AppState.currentTime <= AppState.duration) {
                    Renderer.updateProgress();
                }
            }
            requestAnimationFrame(() => setTimeout(animateProgress, 100));
        }

        // Initialize Application - Run ONCE
        async function init() {
            // Attach all event handlers
            attachEventHandlers();
            
            // Load initial data
            const playlistData = await API.getPlaylists();
            if (playlistData) {
                AppState.playlists = playlistData.playlists;
                Renderer.renderPlaylists();
            }
            
            // Load home view
            Views.home();
            
            // Start real-time updates
            const realtime = new RealtimeUpdates();
            realtime.connect();
            
            // Start progress animation
            animateProgress();
            
            // Backup polling (only when playing)
            setInterval(async () => {
                if (AppState.isPlaying) {
                    const data = await API.getPlayback();
                    if (data) realtime.updatePlayback(data);
                }
            }, 5000);
        }

        // Start the app
        init();
    </script>
</body>
</html>