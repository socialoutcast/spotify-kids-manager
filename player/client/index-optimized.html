<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Spotify</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'spotify-circular';
            src: local('Circular Std'), local('Helvetica Neue'), local('Helvetica'), local('Arial'), sans-serif;
        }

        body {
            font-family: spotify-circular, Helvetica Neue, Helvetica, Arial, sans-serif;
            background: #121212;
            color: #fff;
            overflow: hidden;
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 1fr 90px;
            grid-template-areas:
                "sidebar main"
                "nowplaying nowplaying";
            height: 100vh;
            cursor: none;
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: #000;
            padding: 24px 24px 0;
            overflow-y: auto;
        }

        .logo {
            margin-bottom: 24px;
            height: 40px;
        }

        .logo svg {
            height: 100%;
            fill: #fff;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #b3b3b3;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .nav-item:hover {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-right: 16px;
        }

        /* Search Bar */
        .search-bar {
            position: absolute;
            top: 16px;
            left: 300px;
            right: 20px;
            max-width: 364px;
            z-index: 100;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 48px 12px 48px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 500px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }

        .search-bar input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-bar input:focus {
            background: rgba(255,255,255,0.2);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            fill: rgba(255,255,255,0.7);
        }

        /* Main Content */
        .main-content {
            grid-area: main;
            background: linear-gradient(to bottom, #1e3264 0%, #121212 300px);
            overflow-y: auto;
            padding: 60px 32px 32px;
        }

        .content-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        .card {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 16px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .card:hover {
            background: rgba(255,255,255,0.15);
        }

        .card-image {
            position: relative;
            margin-bottom: 16px;
            border-radius: 4px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .play-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 48px;
            height: 48px;
            background: #1db954;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .card:hover .play-button {
            opacity: 1;
            transform: translateY(0);
        }

        .play-button:hover {
            transform: scale(1.06);
        }

        .play-button svg {
            margin-left: 2px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-subtitle {
            font-size: 12px;
            color: #b3b3b3;
        }

        /* Playlist View */
        .playlist-header {
            display: flex;
            align-items: flex-end;
            margin-bottom: 32px;
            padding-bottom: 24px;
        }

        .playlist-cover {
            width: 232px;
            height: 232px;
            margin-right: 24px;
            box-shadow: 0 4px 60px rgba(0,0,0,.5);
            border-radius: 4px;
            overflow: hidden;
            background: #282828;
        }

        .playlist-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-info h1 {
            font-size: 48px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .playlist-meta {
            color: #b3b3b3;
            font-size: 14px;
        }

        .playlist-controls {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 32px;
        }

        .btn-play-large {
            width: 56px;
            height: 56px;
            background: #1db954;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-play-large:hover {
            transform: scale(1.04);
        }

        .btn-play-large:active {
            transform: scale(0.96);
        }

        /* Track List */
        .track-list {
            margin-top: 24px;
        }

        .track-row {
            display: grid;
            grid-template-columns: 16px 1fr 200px 100px;
            gap: 16px;
            padding: 8px 16px;
            border-radius: 4px;
            align-items: center;
            color: #b3b3b3;
            transition: background 0.2s;
        }

        .track-row:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .track-row.playing {
            color: #1db954;
        }

        .track-number {
            text-align: right;
            font-size: 14px;
        }

        .track-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .track-cover {
            width: 40px;
            height: 40px;
            background: #282828;
            border-radius: 2px;
            overflow: hidden;
        }

        .track-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-details {
            flex: 1;
            min-width: 0;
        }

        .track-name {
            font-size: 16px;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-artist {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-album {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-duration {
            font-size: 14px;
        }

        /* Now Playing Bar */
        .now-playing-bar {
            grid-area: nowplaying;
            background: #181818;
            border-top: 1px solid #282828;
            padding: 0 16px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
        }

        .now-playing-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .now-playing-cover {
            width: 56px;
            height: 56px;
            background: #282828;
            border-radius: 4px;
            overflow: hidden;
        }

        .now-playing-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .now-playing-info {
            min-width: 0;
        }

        .now-playing-name {
            font-size: 14px;
            font-weight: 400;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing-artist {
            font-size: 11px;
            color: #b3b3b3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Player Controls */
        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .control-button {
            background: none;
            border: none;
            color: #b3b3b3;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .control-button:hover {
            color: #fff;
        }

        .control-button.active {
            color: #1db954;
        }

        .control-button svg {
            width: 16px;
            height: 16px;
        }

        .control-button.play-pause {
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 50%;
            color: #000;
        }

        .control-button.play-pause:hover {
            transform: scale(1.06);
        }

        /* Progress Bar */
        .playback-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            max-width: 600px;
        }

        .progress-time {
            font-size: 11px;
            color: #b3b3b3;
            min-width: 40px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress-bar-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            position: relative;
            pointer-events: none;
        }

        .progress-bar:hover .progress-bar-fill {
            background: #1db954;
        }

        /* Volume Controls */
        .now-playing-right {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
        }

        .volume-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 125px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .volume-fill {
            height: 100%;
            background: #fff;
            border-radius: 2px;
            pointer-events: none;
        }

        /* Playlists Section */
        .playlists-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #282828;
        }

        .playlists-header {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #b3b3b3;
            margin-bottom: 12px;
            padding: 0 16px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            color: #b3b3b3;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border-radius: 4px;
        }

        .playlist-item:hover {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .playlist-item.active {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Logo -->
        <div class="logo">
            <svg viewBox="0 0 1134 340">
                <path fill="currentColor" d="M8 171c0 92 76 168 168 168s168-76 168-168S268 4 176 4 8 79 8 171zm230 78c-39-24-71-56-71-56s32-32 71-56c16-10 24-25 24-41 0-23-19-42-42-42s-42 19-42 42c0 16-8 31-24 41-39 24-71 56-71 56s32 32 71 56c16 10 24 25 24 41 0 23 19 42 42 42s42-19 42-42c0-16 8-31 24-41zm46-77c0-46-37-83-83-83s-83 37-83 83 37 83 83 83 83-37 83-83z"/>
            </svg>
        </div>
        
        <!-- Navigation -->
        <nav>
            <a class="nav-item active" data-view="home">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12.5 3.247a1 1 0 00-1 0L4 7.577V20h4.5v-6a1 1 0 011-1h5a1 1 0 011 1v6H20V7.577l-7.5-4.33z"/>
                </svg>
                Home
            </a>
            <a class="nav-item" data-view="search">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"/>
                </svg>
                Search
            </a>
        </nav>
        
        <!-- Playlists -->
        <div class="playlists-section">
            <div class="playlists-header">Playlists</div>
            <div id="playlists"></div>
        </div>
    </aside>
    
    <!-- Search Bar -->
    <div class="search-bar hidden" id="searchBar">
        <svg class="search-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"/>
        </svg>
        <input type="text" placeholder="What do you want to listen to?" id="searchInput">
    </div>
    
    <!-- Main Content Area -->
    <main class="main-content" id="mainContent"></main>
    
    <!-- Now Playing Bar -->
    <div class="now-playing-bar">
        <div class="now-playing-left">
            <div class="now-playing-cover" id="nowPlayingCover"></div>
            <div class="now-playing-info">
                <div class="now-playing-name" id="nowPlayingName">-</div>
                <div class="now-playing-artist" id="nowPlayingArtist">-</div>
            </div>
        </div>
        
        <div class="player-controls">
            <div class="control-buttons">
                <button class="control-button" id="shuffleBtn">
                    <svg viewBox="0 0 16 16">
                        <path fill="currentColor" d="M13.151.922a.75.75 0 10-1.06 1.06L13.109 3H11.16a3.75 3.75 0 00-2.873 1.34l-6.173 7.356A2.25 2.25 0 01.39 12.5H0V14h.391a3.75 3.75 0 002.873-1.34l6.173-7.356a2.25 2.25 0 011.724-.804h1.947l-1.017 1.018a.75.75 0 001.06 1.06L15.98 3.75 13.15.922zM.391 3.5H0V2h.391c1.109 0 2.16.49 2.873 1.34L4.89 5.277l-.979 1.167-1.796-2.14A2.25 2.25 0 00.39 3.5z"/>
                    </svg>
                </button>
                <button class="control-button" id="prevBtn">
                    <svg viewBox="0 0 16 16">
                        <path fill="currentColor" d="M3.3 1a.7.7 0 01.7.7v5.15l9.95-5.744a.7.7 0 011.05.606v12.575a.7.7 0 01-1.05.607L4 9.149V14.3a.7.7 0 01-.7.7H1.7a.7.7 0 01-.7-.7V1.7a.7.7 0 01.7-.7h1.6z"/>
                    </svg>
                </button>
                <button class="control-button play-pause" id="playPauseBtn">
                    <svg viewBox="0 0 16 16">
                        <path fill="currentColor" d="M3 1.713a.7.7 0 011.05-.607l10.89 6.288a.7.7 0 010 1.212L4.05 14.894A.7.7 0 013 14.288V1.713z"/>
                    </svg>
                </button>
                <button class="control-button" id="nextBtn">
                    <svg viewBox="0 0 16 16">
                        <path fill="currentColor" d="M12.7 1a.7.7 0 00-.7.7v5.15L2.05 1.107A.7.7 0 001 1.712v12.575a.7.7 0 001.05.607L12 9.149V14.3a.7.7 0 00.7.7h1.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-1.6z"/>
                    </svg>
                </button>
                <button class="control-button" id="repeatBtn">
                    <svg viewBox="0 0 16 16">
                        <path fill="currentColor" d="M0 4.75A3.75 3.75 0 013.75 1h8.5A3.75 3.75 0 0116 4.75v5a3.75 3.75 0 01-3.75 3.75H9.81l1.018 1.018a.75.75 0 11-1.06 1.06L6.939 12.75l2.829-2.828a.75.75 0 111.06 1.06L9.811 12h2.439a2.25 2.25 0 002.25-2.25v-5a2.25 2.25 0 00-2.25-2.25h-8.5A2.25 2.25 0 001.5 4.75v5A2.25 2.25 0 003.75 12H5v1.5H3.75A3.75 3.75 0 010 9.75v-5z"/>
                    </svg>
                </button>
            </div>
            
            <div class="playback-bar">
                <div class="progress-time" id="progressTime">0:00</div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                </div>
                <div class="progress-time" id="durationTime">0:00</div>
            </div>
        </div>
        
        <div class="now-playing-right">
            <div class="volume-bar">
                <button class="control-button">
                    <svg viewBox="0 0 16 16">
                        <path fill="currentColor" d="M9.741.85a.75.75 0 01.375.65v13a.75.75 0 01-1.125.65l-6.925-4a3.642 3.642 0 01-1.33-4.967 3.639 3.639 0 011.33-1.332l6.925-4a.75.75 0 01.75 0zm-6.924 5.3a2.139 2.139 0 000 3.7l5.8 3.35V2.8l-5.8 3.35zm8.683 4.29V5.56a2.75 2.75 0 010 4.88z"/>
                    </svg>
                </button>
                <div class="volume-slider" id="volumeSlider">
                    <div class="volume-fill" id="volumeFill" style="width: 50%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Application State - Single source of truth
        const AppState = {
            currentView: null,
            currentPlaylistId: null,
            playlists: [],
            currentTrack: null,
            isPlaying: false,
            progress: 0,
            duration: 0,
            volume: 50,
            shuffleState: false,
            repeatState: 'off',
            searchQuery: '',
            lastUpdateTime: 0,
            viewCache: {},
            renderCache: {}
        };

        // DOM Elements - Cache once
        const DOM = {};
        
        function initDOM() {
            DOM.sidebar = document.querySelector('.sidebar');
            DOM.playlists = document.getElementById('playlists');
            DOM.mainContent = document.getElementById('mainContent');
            DOM.searchBar = document.getElementById('searchBar');
            DOM.searchInput = document.getElementById('searchInput');
            DOM.nowPlayingCover = document.getElementById('nowPlayingCover');
            DOM.nowPlayingName = document.getElementById('nowPlayingName');
            DOM.nowPlayingArtist = document.getElementById('nowPlayingArtist');
            DOM.playPauseBtn = document.getElementById('playPauseBtn');
            DOM.prevBtn = document.getElementById('prevBtn');
            DOM.nextBtn = document.getElementById('nextBtn');
            DOM.shuffleBtn = document.getElementById('shuffleBtn');
            DOM.repeatBtn = document.getElementById('repeatBtn');
            DOM.progressBar = document.getElementById('progressBar');
            DOM.progressBarFill = document.getElementById('progressBarFill');
            DOM.progressTime = document.getElementById('progressTime');
            DOM.durationTime = document.getElementById('durationTime');
            DOM.volumeSlider = document.getElementById('volumeSlider');
            DOM.volumeFill = document.getElementById('volumeFill');
            DOM.navItems = document.querySelectorAll('.nav-item');
        }

        // API Handler
        const API = {
            async request(endpoint, options = {}) {
                try {
                    const res = await fetch(`/api${endpoint}`, options);
                    return res.ok ? await res.json() : null;
                } catch (e) {
                    console.error('API Error:', e);
                    return null;
                }
            },
            
            getPlaylists: () => API.request('/playlists'),
            getPlayback: () => API.request('/playback'),
            getPlaylistTracks: (id) => API.request(`/playlist/${id}`),
            search: (q) => API.request(`/search?q=${encodeURIComponent(q)}`),
            play: () => API.request('/play', { method: 'POST' }),
            pause: () => API.request('/pause', { method: 'POST' }),
            next: () => API.request('/next', { method: 'POST' }),
            previous: () => API.request('/previous', { method: 'POST' }),
            seek: (position) => API.request('/seek', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ position })
            }),
            setVolume: (volume) => API.request('/volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ volume })
            }),
            shuffle: (state) => API.request('/shuffle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state })
            }),
            repeat: (state) => API.request('/repeat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state })
            }),
            playUri: (uri) => API.request('/play-uri', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uri })
            }),
            playPlaylist: (uri) => API.request('/play-playlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uri })
            })
        };

        // Renderer - Efficient DOM updates
        const Renderer = {
            updateElement(element, content) {
                if (!element) return;
                if (element.textContent !== content) {
                    element.textContent = content;
                }
            },
            
            updateAttribute(element, attr, value) {
                if (!element) return;
                if (element.getAttribute(attr) !== value) {
                    element.setAttribute(attr, value);
                }
            },
            
            updateStyle(element, prop, value) {
                if (!element) return;
                if (element.style[prop] !== value) {
                    element.style[prop] = value;
                }
            },
            
            toggleClass(element, className, condition) {
                if (!element) return;
                const hasClass = element.classList.contains(className);
                if (condition && !hasClass) {
                    element.classList.add(className);
                } else if (!condition && hasClass) {
                    element.classList.remove(className);
                }
            },
            
            renderPlaylists() {
                if (!DOM.playlists || !AppState.playlists) return;
                
                const currentHTML = DOM.playlists.innerHTML;
                const newHTML = AppState.playlists.map(p => 
                    `<div class="playlist-item" data-id="${p.id}">${p.name}</div>`
                ).join('');
                
                if (currentHTML !== newHTML) {
                    DOM.playlists.innerHTML = newHTML;
                }
            },
            
            updateNowPlaying() {
                const track = AppState.currentTrack;
                if (!track) return;
                
                // Update text content
                Renderer.updateElement(DOM.nowPlayingName, track.name || '-');
                Renderer.updateElement(DOM.nowPlayingArtist, track.artists?.join(', ') || '-');
                
                // Update cover if changed
                const coverUrl = track.album?.images?.[0]?.url;
                if (coverUrl && !DOM.nowPlayingCover.querySelector(`img[src="${coverUrl}"]`)) {
                    DOM.nowPlayingCover.innerHTML = `<img src="${coverUrl}" alt="">`;
                }
                
                // Update play/pause button
                const isPlaying = AppState.isPlaying;
                const pauseSvg = '<svg viewBox="0 0 16 16"><path fill="currentColor" d="M2.7 1a.7.7 0 00-.7.7v12.6a.7.7 0 00.7.7h2.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7H2.7zm8 0a.7.7 0 00-.7.7v12.6a.7.7 0 00.7.7h2.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-2.6z"/></svg>';
                const playSvg = '<svg viewBox="0 0 16 16"><path fill="currentColor" d="M3 1.713a.7.7 0 011.05-.607l10.89 6.288a.7.7 0 010 1.212L4.05 14.894A.7.7 0 013 14.288V1.713z"/></svg>';
                
                if (DOM.playPauseBtn.innerHTML !== (isPlaying ? pauseSvg : playSvg)) {
                    DOM.playPauseBtn.innerHTML = isPlaying ? pauseSvg : playSvg;
                }
                
                // Update control states
                Renderer.toggleClass(DOM.shuffleBtn, 'active', AppState.shuffleState);
                Renderer.toggleClass(DOM.repeatBtn, 'active', AppState.repeatState !== 'off');
            },
            
            updateProgress() {
                const progress = AppState.progress || 0;
                const duration = AppState.duration || 0;
                const percentage = duration > 0 ? (progress / duration) * 100 : 0;
                
                Renderer.updateStyle(DOM.progressBarFill, 'width', `${percentage}%`);
                Renderer.updateElement(DOM.progressTime, this.formatTime(progress));
                Renderer.updateElement(DOM.durationTime, this.formatTime(duration));
            },
            
            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        };

        // View Manager - Cached view rendering
        const Views = {
            home() {
                if (AppState.currentView === 'home' && AppState.viewCache.home) {
                    DOM.mainContent.innerHTML = AppState.viewCache.home;
                    return;
                }
                
                AppState.currentView = 'home';
                const greeting = this.getGreeting();
                
                const html = `
                    <div class="content-section">
                        <h2 class="section-title">Good ${greeting}</h2>
                        <div class="cards-grid" id="homeCards">
                            ${AppState.playlists.slice(0, 6).map(p => `
                                <div class="card" data-id="${p.id}" data-uri="${p.uri}">
                                    <div class="card-image">
                                        ${p.images?.[0]?.url ? 
                                            `<img src="${p.images[0].url}" alt="">` : 
                                            '<div style="background: #282828; width: 100%; height: 100%;"></div>'
                                        }
                                        <button class="play-button" data-uri="${p.uri}">
                                            <svg viewBox="0 0 24 24" width="24" height="24">
                                                <path fill="currentColor" d="M7.05 3.606l13.49 7.788a.7.7 0 010 1.212L7.05 20.394A.7.7 0 016 19.788V4.212a.7.7 0 011.05-.606z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="card-title">${p.name}</div>
                                    <div class="card-subtitle">Playlist</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                AppState.viewCache.home = html;
                DOM.mainContent.innerHTML = html;
                this.updateNavigation('home');
            },
            
            async loadPlaylist(playlistId) {
                if (AppState.currentView === 'playlist' && 
                    AppState.currentPlaylistId === playlistId && 
                    AppState.viewCache[`playlist-${playlistId}`]) {
                    DOM.mainContent.innerHTML = AppState.viewCache[`playlist-${playlistId}`];
                    return;
                }
                
                AppState.currentView = 'playlist';
                AppState.currentPlaylistId = playlistId;
                
                DOM.mainContent.innerHTML = '<div style="padding: 40px; text-align: center;">Loading...</div>';
                
                const data = await API.getPlaylistTracks(playlistId);
                if (!data) {
                    DOM.mainContent.innerHTML = '<div style="padding: 40px; text-align: center;">Failed to load playlist</div>';
                    return;
                }
                
                const playlist = data.playlist;
                const html = `
                    <div class="playlist-header">
                        <div class="playlist-cover">
                            ${playlist.images?.[0]?.url ? 
                                `<img src="${playlist.images[0].url}" alt="">` : 
                                '<div style="background: #282828; width: 100%; height: 100%;"></div>'
                            }
                        </div>
                        <div class="playlist-info">
                            <div style="font-size: 12px; font-weight: 700; text-transform: uppercase;">Playlist</div>
                            <h1>${playlist.name}</h1>
                            <div class="playlist-meta">${playlist.tracks?.length || 0} songs</div>
                        </div>
                    </div>
                    <div class="playlist-controls">
                        <button class="btn-play-large" data-uri="${playlist.uri}">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M7.05 3.606l13.49 7.788a.7.7 0 010 1.212L7.05 20.394A.7.7 0 016 19.788V4.212a.7.7 0 011.05-.606z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="track-list">
                        ${playlist.tracks?.map((track, i) => `
                            <div class="track-row" data-uri="${track.uri}">
                                <div class="track-number">${i + 1}</div>
                                <div class="track-info">
                                    <div class="track-cover">
                                        ${track.album?.images?.[0]?.url ? 
                                            `<img src="${track.album.images[0].url}" alt="">` : 
                                            ''
                                        }
                                    </div>
                                    <div class="track-details">
                                        <div class="track-name">${track.name}</div>
                                        <div class="track-artist">${track.artists?.map(a => a.name).join(', ')}</div>
                                    </div>
                                </div>
                                <div class="track-album">${track.album?.name || ''}</div>
                                <div class="track-duration">${this.formatDuration(track.duration_ms)}</div>
                            </div>
                        `).join('') || '<div style="padding: 20px;">No tracks in playlist</div>'}
                    </div>
                `;
                
                AppState.viewCache[`playlist-${playlistId}`] = html;
                DOM.mainContent.innerHTML = html;
            },
            
            async search() {
                if (AppState.currentView === 'search' && !AppState.searchQuery) {
                    return;
                }
                
                AppState.currentView = 'search';
                DOM.searchBar.classList.remove('hidden');
                this.updateNavigation('search');
            },
            
            updateNavigation(view) {
                DOM.navItems.forEach(item => {
                    if (item.dataset.view === view) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            },
            
            getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'morning';
                if (hour < 18) return 'afternoon';
                return 'evening';
            },
            
            formatDuration(ms) {
                const seconds = Math.floor(ms / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        };

        // WebSocket for real-time updates
        class RealtimeUpdates {
            constructor() {
                this.ws = null;
                this.reconnectTimer = null;
            }
            
            connect() {
                if (this.ws?.readyState === WebSocket.OPEN) return;
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${window.location.host}`);
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'playback') {
                            this.updatePlayback(data.data);
                        }
                    } catch (e) {
                        console.error('WebSocket message error:', e);
                    }
                };
                
                this.ws.onerror = () => this.scheduleReconnect();
                this.ws.onclose = () => this.scheduleReconnect();
            }
            
            scheduleReconnect() {
                if (this.reconnectTimer) return;
                this.reconnectTimer = setTimeout(() => {
                    this.reconnectTimer = null;
                    this.connect();
                }, 5000);
            }
            
            updatePlayback(data) {
                if (!data) return;
                
                // Only update if data actually changed
                const hasTrackChanged = JSON.stringify(AppState.currentTrack) !== JSON.stringify(data.item);
                const hasStateChanged = AppState.isPlaying !== data.is_playing ||
                                       AppState.shuffleState !== data.shuffle_state ||
                                       AppState.repeatState !== data.repeat_state;
                
                if (hasTrackChanged) {
                    AppState.currentTrack = data.item;
                }
                
                if (hasStateChanged) {
                    AppState.isPlaying = data.is_playing;
                    AppState.shuffleState = data.shuffle_state;
                    AppState.repeatState = data.repeat_state;
                }
                
                AppState.progress = data.progress_ms || 0;
                AppState.duration = data.item?.duration_ms || 0;
                
                // Only render if something changed
                if (hasTrackChanged || hasStateChanged) {
                    Renderer.updateNowPlaying();
                }
                Renderer.updateProgress();
            }
        }

        // Event handling
        function attachEventHandlers() {
            // Navigation
            DOM.navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = item.dataset.view;
                    if (view === 'home') Views.home();
                    else if (view === 'search') Views.search();
                });
            });
            
            // Playlist selection
            DOM.playlists.addEventListener('click', (e) => {
                const item = e.target.closest('.playlist-item');
                if (item) {
                    Views.loadPlaylist(item.dataset.id);
                }
            });
            
            // Play buttons (delegated)
            DOM.mainContent.addEventListener('click', (e) => {
                const playBtn = e.target.closest('.play-button, .btn-play-large');
                if (playBtn && playBtn.dataset.uri) {
                    API.playPlaylist(playBtn.dataset.uri);
                }
                
                const trackRow = e.target.closest('.track-row');
                if (trackRow && trackRow.dataset.uri) {
                    API.playUri(trackRow.dataset.uri);
                }
                
                const card = e.target.closest('.card');
                if (card && !e.target.closest('.play-button')) {
                    Views.loadPlaylist(card.dataset.id);
                }
            });
            
            // Search
            let searchTimer;
            DOM.searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimer);
                const query = e.target.value.trim();
                AppState.searchQuery = query;
                
                if (!query) {
                    Views.home();
                    return;
                }
                
                searchTimer = setTimeout(async () => {
                    const results = await API.search(query);
                    if (results) {
                        renderSearchResults(results);
                    }
                }, 300);
            });
            
            // Playback controls
            DOM.playPauseBtn.onclick = () => AppState.isPlaying ? API.pause() : API.play();
            DOM.prevBtn.onclick = () => API.previous();
            DOM.nextBtn.onclick = () => API.next();
            DOM.shuffleBtn.onclick = () => API.shuffle(!AppState.shuffleState);
            DOM.repeatBtn.onclick = () => {
                const states = ['off', 'context', 'track'];
                const current = states.indexOf(AppState.repeatState);
                API.repeat(states[(current + 1) % states.length]);
            };
            
            // Progress bar
            DOM.progressBar.addEventListener('click', (e) => {
                const rect = DOM.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const position = Math.floor(percent * AppState.duration);
                API.seek(position);
            });
            
            // Volume
            DOM.volumeSlider.addEventListener('click', (e) => {
                const rect = DOM.volumeSlider.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const volume = Math.floor(percent * 100);
                AppState.volume = volume;
                Renderer.updateStyle(DOM.volumeFill, 'width', `${volume}%`);
                API.setVolume(volume);
            });
        }

        function renderSearchResults(results) {
            const html = `
                <div class="content-section">
                    <h2 class="section-title">Search Results</h2>
                    <div class="cards-grid">
                        ${results.items?.map(item => `
                            <div class="card" data-id="${item.id}" data-uri="${item.uri}">
                                <div class="card-image">
                                    ${item.images?.[0]?.url ? 
                                        `<img src="${item.images[0].url}" alt="">` : 
                                        '<div style="background: #282828; width: 100%; height: 100%;"></div>'
                                    }
                                    <button class="play-button" data-uri="${item.uri}">
                                        <svg viewBox="0 0 24 24" width="24" height="24">
                                            <path fill="currentColor" d="M7.05 3.606l13.49 7.788a.7.7 0 010 1.212L7.05 20.394A.7.7 0 016 19.788V4.212a.7.7 0 011.05-.606z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="card-title">${item.name}</div>
                                <div class="card-subtitle">${item.type === 'track' ? item.artists?.map(a => a.name).join(', ') : 'Playlist'}</div>
                            </div>
                        `).join('') || '<div>No results found</div>'}
                    </div>
                </div>
            `;
            DOM.mainContent.innerHTML = html;
        }

        // Animation loop for smooth progress
        function animateProgress() {
            if (AppState.isPlaying && AppState.progress < AppState.duration) {
                AppState.progress += 100;
                Renderer.updateProgress();
            }
            requestAnimationFrame(() => setTimeout(animateProgress, 100));
        }

        // Initialize Application
        async function init() {
            // Initialize DOM references
            initDOM();
            
            // Attach event handlers
            attachEventHandlers();
            
            // Load initial data
            const playlistData = await API.getPlaylists();
            if (playlistData) {
                AppState.playlists = playlistData.playlists;
                Renderer.renderPlaylists();
            }
            
            // Load home view
            Views.home();
            
            // Start real-time updates
            const realtime = new RealtimeUpdates();
            realtime.connect();
            
            // Start progress animation
            animateProgress();
            
            // Backup polling - minimal and conditional
            setInterval(async () => {
                // Only poll when playing to reduce unnecessary updates
                if (AppState.isPlaying) {
                    const data = await API.getPlayback();
                    if (data) realtime.updatePlayback(data);
                }
            }, 5000);
        }

        // Start the app
        init();
    </script>
</body>
</html>