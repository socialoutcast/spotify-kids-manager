<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Spotify</title>
    <style>
        :root {
            --spotify-green: #1db954;
            --spotify-green-hover: #1ed760;
            --sidebar-bg: #000;
            --main-bg: #121212;
            --card-bg: #181818;
            --card-hover: #282828;
            --text-primary: #fff;
            --text-secondary: #b3b3b3;
            --text-subdued: #a7a7a7;
            --playbar-bg: #181818;
            --border-color: #282828;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            cursor: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--main-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        /* Main Container */
        .spotify-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 1fr;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            overflow: hidden;
        }

        .sidebar-section {
            background: var(--main-bg);
            border-radius: 8px;
            padding: 16px 20px;
        }

        .sidebar-section.library {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            padding: 8px 8px;
        }

        /* Logo - Removed to save space */

        /* Navigation */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 700;
            font-size: 16px;
            transition: color 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--text-primary);
        }

        .nav-link.active {
            color: var(--text-primary);
        }

        .nav-link svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        /* Library Header */
        .library-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 8px;
        }

        .library-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .library-title:hover {
            color: var(--text-primary);
        }

        .library-title svg {
            width: 24px;
            height: 24px;
        }

        /* Playlist List */
        .playlist-list {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            min-height: 0;
            max-height: calc(100vh - 220px); /* More space with logo removed */
        }

        .playlist-list::-webkit-scrollbar {
            width: 12px;
        }

        .playlist-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .playlist-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 6px;
        }

        .playlist-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.4);
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 56px; /* Better touch target */
        }

        .playlist-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .playlist-item.active {
            background: rgba(255,255,255,0.2);
        }

        .playlist-cover {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--card-bg);
            flex-shrink: 0;
        }

        .playlist-cover.liked-songs {
            background: linear-gradient(135deg, #450af5, #c4efd9);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .playlist-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-name {
            font-size: 16px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .playlist-type {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        /* Main View */
        .main-view {
            background: var(--main-bg);
            overflow-y: auto;
            position: relative;
        }

        .main-view::-webkit-scrollbar {
            width: 12px;
        }

        .main-view::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
        }

        /* Header with gradient */
        .main-header {
            height: 64px;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: transparent;
            z-index: 10;
        }

        /* Content Container */
        .main-content {
            padding: 0 32px 32px;
        }

        /* Home View */
        .home-view {
            padding-top: 24px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
        }

        .section-link {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
        }

        .section-link:hover {
            text-decoration: underline;
        }

        /* Quick Access Cards (Good morning/afternoon/evening) */
        .quick-access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 8px;
            margin-bottom: 40px;
        }

        .quick-card {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            overflow: hidden;
            cursor: pointer;
            transition: background 0.3s;
            height: 80px;
        }

        .quick-card:hover {
            background: rgba(255,255,255,0.2);
        }

        .quick-card-image {
            width: 80px;
            height: 80px;
            background: var(--card-bg);
            flex-shrink: 0;
        }

        .quick-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .quick-card-info {
            padding: 16px;
            flex: 1;
            min-width: 0;
        }

        .quick-card-title {
            font-size: 16px;
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .quick-card-play {
            width: 48px;
            height: 48px;
            background: var(--spotify-green);
            border-radius: 50%;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s, background 0.1s;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border: none;
            cursor: pointer;
        }

        .quick-card:hover .quick-card-play {
            opacity: 1;
        }

        .quick-card-play:hover {
            background: var(--spotify-green-hover);
            transform: scale(1.06);
        }

        /* Regular Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 16px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .card:hover {
            background: var(--card-hover);
        }

        .card-image-container {
            position: relative;
            margin-bottom: 16px;
        }

        .card-image {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 4px;
            overflow: hidden;
            background: #282828;
            position: relative;
        }

        .card-image.artist {
            border-radius: 50%;
        }

        .card-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-play-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 48px;
            height: 48px;
            background: var(--spotify-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border: none;
            cursor: pointer;
        }

        .card:hover .card-play-button {
            opacity: 1;
            transform: translateY(0);
        }

        .card-play-button:hover {
            background: var(--spotify-green-hover);
            transform: scale(1.06);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3em;
            max-height: 2.6em;
        }

        /* Playlist View */
        .playlist-view {
            margin-top: -64px;
        }

        .playlist-header-bg {
            height: 340px;
            padding: 64px 32px 24px;
            display: flex;
            align-items: flex-end;
            background: linear-gradient(transparent 0, rgba(0,0,0,.5) 100%);
        }

        .playlist-header-content {
            display: flex;
            gap: 24px;
            align-items: flex-end;
            width: 100%;
        }

        .playlist-artwork {
            width: 232px;
            height: 232px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--card-bg);
            box-shadow: 0 4px 60px rgba(0,0,0,.5);
            flex-shrink: 0;
        }

        .playlist-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-details {
            flex: 1;
            min-width: 0;
        }

        .playlist-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .playlist-title {
            font-size: clamp(48px, 6vw, 96px);
            font-weight: 900;
            line-height: 1;
            margin: 8px 0 12px;
        }

        .playlist-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .playlist-stats {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .playlist-controls {
            padding: 24px 32px;
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .btn-play-large {
            width: 56px;
            height: 56px;
            background: var(--spotify-green);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn-play-large:hover {
            transform: scale(1.06);
            background: var(--spotify-green-hover);
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: var(--text-primary);
        }

        /* Track List */
        .track-list {
            padding: 0;
            width: 100%;
            margin-left: -8px;
        }

        .track-list-header {
            display: grid;
            grid-template-columns: [index] 40px [title] minmax(300px, 1fr) [album] minmax(200px, 0.8fr) [duration] 80px;
            gap: 16px;
            padding: 8px 16px 8px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .track-row {
            display: grid;
            grid-template-columns: [index] 40px [title] minmax(300px, 1fr) [album] minmax(200px, 0.8fr) [duration] 80px;
            gap: 16px;
            padding: 8px 16px 8px 8px;
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background 0.2s;
            align-items: center;
            height: 56px;
        }

        .track-row:hover {
            background: rgba(255,255,255,0.1);
        }

        .track-row.playing {
            color: var(--spotify-green);
        }

        .track-index {
            text-align: center;
            font-size: 16px;
        }

        .track-title-group {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 0;
        }

        .track-image {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border-radius: 2px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .track-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-title-info {
            min-width: 0;
            flex: 1;
        }

        .track-title {
            font-size: 16px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-row.playing .track-title {
            color: var(--spotify-green);
        }

        .track-artists {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-album {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-date {
            font-size: 14px;
        }

        .track-duration {
            text-align: right;
            font-size: 14px;
        }

        /* Now Playing Bar */
        .now-playing-bar {
            height: 90px;
            background: var(--playbar-bg);
            border-top: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 30% 40% 30%;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }

        /* Left - Track Info */
        .now-playing-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .now-playing-cover {
            width: 56px;
            height: 56px;
            background: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }
        
        .now-playing-cover::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .now-playing-cover:hover::after {
            opacity: 1;
        }

        .now-playing-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .now-playing-info {
            min-width: 0;
        }

        .now-playing-title {
            font-size: 14px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing-artist {
            font-size: 11px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }

        /* Center - Player Controls */
        .now-playing-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            max-width: 722px;
            margin: 0 auto;
            width: 100%;
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .control-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-button:hover {
            color: var(--text-primary);
        }

        .control-button.active {
            color: var(--spotify-green);
        }

        .control-button svg {
            width: 16px;
            height: 16px;
        }

        .control-button.play-pause {
            width: 32px;
            height: 32px;
            background: var(--text-primary);
            border-radius: 50%;
            color: #000;
        }

        .control-button.play-pause:hover {
            transform: scale(1.06);
        }

        .playback-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .time-label {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 40px;
        }

        .time-label:first-child {
            text-align: right;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress-bar:hover .progress-fill {
            background: var(--spotify-green);
        }

        .progress-fill {
            height: 100%;
            background: var(--text-primary);
            border-radius: 2px;
            position: relative;
            width: 0%;
            transition: background 0.2s;
        }

        /* Right - Extra Controls */
        .now-playing-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 16px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 125px;
        }

        .volume-bar {
            width: 93px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .volume-bar:hover .volume-fill {
            background: var(--spotify-green);
        }

        .volume-fill {
            height: 100%;
            background: var(--text-primary);
            border-radius: 2px;
            width: 50%;
            position: relative;
            transition: background 0.2s;
        }

        /* Play Icon */
        .play-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .play-icon-large {
            width: 24px;
            height: 24px;
            fill: #000;
        }

        /* Expanded Now Playing View - Optimized for Pi touchscreen */
        .expanded-now-playing {
            position: fixed;
            top: 5%;
            left: 5%;
            right: 5%;
            bottom: 5%;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        
        .expanded-now-playing.active {
            display: flex;
        }
        
        .expanded-content {
            display: flex;
            width: 100%;
            height: 100%;
        }
        
        .expanded-left {
            width: 45%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent);
        }
        
        .expanded-artwork {
            width: 100%;
            max-width: 280px;
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        
        .expanded-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .expanded-right {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .expanded-info {
            margin-bottom: 20px;
        }
        
        .expanded-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.2;
        }
        
        .expanded-artist {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .expanded-actions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .expanded-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 15px;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            min-height: 48px; /* Better touch target */
        }
        
        .expanded-action:hover,
        .expanded-action:active {
            background: rgba(255,255,255,0.15);
        }
        
        .expanded-action svg {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }
        
        .expanded-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 10;
        }
        
        .expanded-close:hover,
        .expanded-close:active {
            background: rgba(255,255,255,0.25);
        }
        
        .expanded-close svg {
            width: 24px;
            height: 24px;
        }
        
        /* Overlay */
        .expanded-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }
        
        .expanded-overlay.active {
            display: block;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Search View */
        .search-container {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 32px;
        }
        
        /* Home Search Bar */
        .home-search-bar {
            position: relative;
            margin-bottom: 32px;
            max-width: 400px;
        }
        
        .home-search-input {
            width: 100%;
            padding: 12px 40px;
            background: var(--card-bg);
            border: none;
            border-radius: 500px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }
        
        .home-search-input::placeholder {
            color: var(--text-secondary);
        }
        
        .home-search-input:focus {
            outline: 2px solid var(--text-primary);
        }
        
        .home-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
        }

        .search-input {
            width: 100%;
            padding: 14px 48px;
            background: var(--card-bg);
            border: none;
            border-radius: 500px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            outline: 2px solid var(--text-primary);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            fill: var(--text-secondary);
        }

        .search-clear {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .search-clear.visible {
            display: flex;
        }

        .search-results {
            display: grid;
            gap: 24px;
        }

        .search-section {
            margin-bottom: 32px;
        }

        .search-section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        .search-item {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 16px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .search-item:hover {
            background: var(--card-hover);
        }

        .search-item-image {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            margin-bottom: 12px;
            background: var(--border-color);
        }

        .search-item-image.artist {
            border-radius: 50%;
        }

        .search-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .search-item-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-item-type {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        /* On-screen Keyboard */
        .keyboard-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 12px;
            display: none;
            z-index: 1000;
        }

        .keyboard-container.active {
            display: block;
        }

        .keyboard-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            justify-content: center;
        }

        .keyboard-key {
            min-width: 32px;
            height: 48px;
            padding: 0 12px;
            background: var(--main-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            user-select: none;
        }

        .keyboard-key:active {
            background: var(--spotify-green);
            transform: scale(0.95);
        }

        .keyboard-key.space {
            flex: 1;
            max-width: 300px;
        }

        .keyboard-key.backspace,
        .keyboard-key.enter {
            min-width: 80px;
            background: var(--border-color);
        }

        .keyboard-key.shift {
            min-width: 100px;
            background: var(--border-color);
        }

        .keyboard-key.shift.active {
            background: var(--spotify-green);
        }

        .keyboard-close {
            position: absolute;
            top: -40px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="spotify-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <nav>
                    <a class="nav-link active" data-view="home">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12.5 3.247a1 1 0 00-1 0L4 7.577V20h4.5v-6a1 1 0 011-1h5a1 1 0 011 1v6H20V7.577l-7.5-4.33zm-2-1.732a3 3 0 013 0l7.5 4.33a2 2 0 011 1.732V21a1 1 0 01-1 1h-6.5a1 1 0 01-1-1v-6h-3v6a1 1 0 01-1 1H3a1 1 0 01-1-1V7.577a2 2 0 011-1.732l7.5-4.33z"/>
                        </svg>
                        <span>Home</span>
                    </a>
                    <a class="nav-link" data-view="search">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"/>
                        </svg>
                        <span>Search</span>
                    </a>
                </nav>
            </div>
            
            <div class="sidebar-section library">
                <div class="library-header">
                    <div class="library-title">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M14.5 2.134a1 1 0 011 0l6 3.464a1 1 0 01.5.866V21a1 1 0 01-1 1h-6a1 1 0 01-1-1V3a1 1 0 01.5-.866zM16 4.732V20h4V7.041l-4-2.309zM3 22a1 1 0 01-1-1V3a1 1 0 012 0v18a1 1 0 01-1 1zm6 0a1 1 0 01-1-1V3a1 1 0 012 0v18a1 1 0 01-1 1z"/>
                        </svg>
                        <span>Your Library</span>
                    </div>
                </div>
                <div class="playlist-list" id="playlistList">
                    <!-- Playlists will be added here -->
                </div>
            </div>
        </div>
        
        <!-- Main View -->
        <div class="main-view" id="mainView">
            <header class="main-header">
                <!-- Header content -->
            </header>
            <div class="main-content" id="mainContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Overlay -->
    <div class="expanded-overlay" id="expandedOverlay"></div>
    
    <!-- Expanded Now Playing View -->
    <div class="expanded-now-playing" id="expandedNowPlaying">
        <button class="expanded-close" id="expandedClose">
            <svg width="20" height="20" viewBox="0 0 16 16">
                <path fill="currentColor" d="M2.96 1.848l11.192 11.192-1.06 1.06L1.9 2.908z"/>
                <path fill="currentColor" d="M14.092 2.908L2.9 14.1l-1.06-1.06L13.032 1.848z"/>
            </svg>
        </button>
        <div class="expanded-content">
            <div class="expanded-left">
                <div class="expanded-artwork" id="expandedArtwork">
                    <!-- Album art will be inserted here -->
                </div>
            </div>
            <div class="expanded-right">
                <div class="expanded-info">
                    <div class="expanded-title" id="expandedTitle">-</div>
                    <div class="expanded-artist" id="expandedArtist">-</div>
                </div>
                <div class="expanded-actions">
                    <button class="expanded-action" id="startRadio">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M6 3l0.01 10.55c-.59-.34-1.27-.55-2-.55C2.34 13 1 14.34 1 16s1.34 3 3.01 3S7 17.66 7 16V6h11v4.55c-.59-.34-1.27-.55-2-.55-1.67 0-3.01 1.34-3.01 3s1.34 3 3.01 3S19 14.66 19 13V3H6z"/>
                        </svg>
                        <span>Start Radio</span>
                    </button>
                    <button class="expanded-action" id="goToArtist">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                        </svg>
                        <span>Go to Artist</span>
                    </button>
                    <button class="expanded-action" id="goToAlbum">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
                        </svg>
                        <span>Go to Album</span>
                    </button>
                    <button class="expanded-action" id="addToPlaylist">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M14 10H2v2h12v-2zm0-4H2v2h12V6zm4 8v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM2 16h8v-2H2v2z"/>
                        </svg>
                        <span>Add to Playlist</span>
                    </button>
                    <button class="expanded-action" id="showCredits">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
                        </svg>
                        <span>Show Credits</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Now Playing Bar -->
    <div class="now-playing-bar">
        <div class="now-playing-left">
            <div class="now-playing-cover" id="nowPlayingCover"></div>
            <div class="now-playing-info">
                <div class="now-playing-title" id="nowPlayingTitle">-</div>
                <div class="now-playing-artist" id="nowPlayingArtist">-</div>
            </div>
            <div class="now-playing-actions">
                <button class="control-button" id="likeBtn">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <path fill="none" stroke="currentColor" d="M1.69 2A4.582 4.582 0 018 2.023 4.583 4.583 0 0111.88.817h.002a4.618 4.618 0 013.782 3.65v.003a4.543 4.543 0 01-1.011 3.84L9.35 14.629a1.765 1.765 0 01-2.093.464 1.762 1.762 0 01-.605-.463L1.348 8.309A4.582 4.582 0 011.689 2zm3.158.252A3.082 3.082 0 002.49 7.337l.005.005L7.8 13.664a.264.264 0 00.311.069.262.262 0 00.09-.069l5.312-6.33a3.043 3.043 0 00.68-2.573 3.118 3.118 0 00-2.551-2.463 3.079 3.079 0 00-2.612.816l-.007.007a1.501 1.501 0 01-2.045 0l-.009-.008a3.082 3.082 0 00-2.121-.861z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="now-playing-center">
            <div class="playback-controls">
                <button class="control-button" id="prevBtn">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M3.3 1a.7.7 0 01.7.7v5.15l9.95-5.744a.7.7 0 011.05.606v12.575a.7.7 0 01-1.05.607L4 9.149V14.3a.7.7 0 01-.7.7H1.7a.7.7 0 01-.7-.7V1.7a.7.7 0 01.7-.7h1.6z"/>
                    </svg>
                </button>
                <button class="control-button play-pause" id="playPauseBtn">
                    <svg class="play-icon" viewBox="0 0 16 16">
                        <path d="M3 1.713a.7.7 0 011.05-.607l10.89 6.288a.7.7 0 010 1.212L4.05 14.894A.7.7 0 013 14.288V1.713z"/>
                    </svg>
                </button>
                <button class="control-button" id="nextBtn">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M12.7 1a.7.7 0 00-.7.7v5.15L2.05 1.107A.7.7 0 001 1.712v12.575a.7.7 0 001.05.607L12 9.149V14.3a.7.7 0 00.7.7h1.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-1.6z"/>
                    </svg>
                </button>
            </div>
            
            <div class="playback-bar">
                <div class="time-label" id="currentTime">0:00</div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-label" id="totalTime">0:00</div>
            </div>
        </div>
        
        <div class="now-playing-right">
            <div class="volume-control">
                <button class="control-button" id="volumeBtn">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <path fill="currentColor" d="M10.188 1.093a.75.75 0 0 1 .718.747v12.32a.75.75 0 0 1-1.218.585L5.426 11H2.25A1.25 1.25 0 0 1 1 9.75v-3.5C1 5.56 1.56 5 2.25 5h3.176l4.262-3.745a.75.75 0 0 1 .5-.162zM9.438 2.802 6.172 5.676A.75.75 0 0 1 5.676 5.5H2.25v4h3.426a.75.75 0 0 1 .496.188l3.266 2.874V2.802z"/>
                        <path fill="currentColor" d="M11.5 5.174a4.252 4.252 0 0 1 0 5.652v1.55a5.752 5.752 0 0 0 0-8.752v1.55z"/>
                    </svg>
                </button>
                <div class="volume-bar" id="volumeBar">
                    <div class="volume-fill" id="volumeFill"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // App State
        const state = {
            player: null,
            deviceId: null,
            token: null,
            playlists: [],
            currentView: 'home',
            currentPlaylist: null,
            isPlaying: false,
            volume: 0.5,
            currentTrack: null
        };

        // Initialize
        window.onSpotifyWebPlaybackSDKReady = () => {
            initializePlayer();
        };

        async function getToken() {
            try {
                const res = await fetch('/api/token');
                const data = await res.json();
                state.token = data.access_token;
                return state.token;
            } catch (error) {
                console.error('Failed to get token:', error);
                return null;
            }
        }

        async function initializePlayer() {
            const token = await getToken();
            if (!token) {
                showSetupMessage();
                return;
            }

            state.player = new Spotify.Player({
                name: 'Spotify Kids Player',
                getOAuthToken: async cb => {
                    const newToken = await getToken();
                    cb(newToken);
                },
                volume: state.volume
            });

            // Ready
            state.player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                state.deviceId = device_id;
                
                // Transfer playback
                transferPlayback(device_id);
                
                // Initialize UI
                initializeUI();
                // Load playlists then show home view
                loadPlaylists().then(() => {
                    showHomeView();
                    // Mark home as active
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelector('.nav-link[data-view="home"]').classList.add('active');
                });
            });

            // Not Ready
            state.player.addListener('not_ready', ({ device_id }) => {
                console.log('Device offline', device_id);
            });

            // Player state changed
            state.player.addListener('player_state_changed', playerState => {
                if (!playerState) return;
                
                state.isPlaying = !playerState.paused;
                state.currentTrack = playerState.track_window.current_track;
                
                updateNowPlaying(playerState);
                updatePlayButton(playerState.paused);
                updateProgress(playerState.position, playerState.duration);
            });

            // Connect
            state.player.connect();
        }

        async function transferPlayback(device_id) {
            try {
                await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_ids: [device_id],
                        play: false
                    })
                });
            } catch (error) {
                console.error('Transfer failed:', error);
            }
        }

        function showSetupMessage() {
            const hostname = window.location.hostname;
            const adminUrl = `https://${hostname}`;
            document.getElementById('mainContent').innerHTML = `
                <div class="home-view">
                    <div class="section">
                        <h1 class="section-title">Setup Required</h1>
                        <p style="color: var(--text-secondary); font-size: 18px;">
                            Please log into the admin panel from your PC to complete the Spotify setup.
                        </p>
                        <a href="${adminUrl}" style="display: inline-block; margin-top: 20px; padding: 12px 32px; background: var(--spotify-green); color: #000; border-radius: 500px; text-decoration: none; font-weight: 700;">
                            Go to Admin Panel
                        </a>
                    </div>
                </div>
            `;
        }

        async function loadPlaylists() {
            try {
                const res = await fetch('http://localhost:5000/api/playlists');
                const data = await res.json();
                // Filter out DJ playlists
                state.playlists = data.playlists.filter(playlist => 
                    !playlist.name.toLowerCase().includes('dj') &&
                    !playlist.name.toLowerCase().includes('spotify dj')
                );
                renderPlaylists();
            } catch (error) {
                console.error('Failed to load playlists:', error);
            }
        }

        function renderPlaylists() {
            const container = document.getElementById('playlistList');
            container.innerHTML = state.playlists.map(playlist => {
                const isLikedSongs = playlist.id === 'liked-songs';
                return `
                    <div class="playlist-item" data-id="${playlist.id}">
                        <div class="playlist-cover ${isLikedSongs ? 'liked-songs' : ''}">
                            ${isLikedSongs ? 
                                `<svg width="24" height="24" viewBox="0 0 24 24" fill="#fff">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>` :
                                (playlist.images?.[0]?.url ? 
                                    `<img src="${playlist.images[0].url}" alt="">` : 
                                    '')
                            }
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-name">${playlist.name}</div>
                            <div class="playlist-type">Playlist</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showHomeView() {
            const greeting = getGreeting();
            const quickPlaylists = state.playlists.slice(0, 6);
            const morePlaylists = state.playlists.slice(6, 18);
            
            document.getElementById('mainContent').innerHTML = `
                <div class="home-view">
                    <div class="home-search-bar">
                        <svg class="home-search-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"/>
                        </svg>
                        <input type="text" 
                               class="home-search-input" 
                               id="homeSearchInput" 
                               placeholder="What do you want to listen to?"
                               autocomplete="off">
                    </div>
                    
                    <h1 class="section-title" style="margin-bottom: 24px;">${greeting}</h1>
                    
                    <div class="quick-access-grid">
                        ${quickPlaylists.map(playlist => `
                            <div class="quick-card" data-id="${playlist.id}">
                                <div class="quick-card-image">
                                    ${playlist.images?.[0]?.url ? 
                                        `<img src="${playlist.images[0].url}" alt="">` : 
                                        ''
                                    }
                                </div>
                                <div class="quick-card-info">
                                    <div class="quick-card-title">${playlist.name}</div>
                                </div>
                                <button class="quick-card-play" data-uri="${playlist.uri}">
                                    <svg class="play-icon-large" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${morePlaylists.length > 0 ? `
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title">Your playlists</h2>
                            </div>
                            <div class="cards-grid">
                                ${morePlaylists.map(playlist => `
                                    <div class="card" data-id="${playlist.id}">
                                        <div class="card-image-container">
                                            <div class="card-image">
                                                ${playlist.images?.[0]?.url ? 
                                                    `<img src="${playlist.images[0].url}" alt="">` : 
                                                    ''
                                                }
                                            </div>
                                            <button class="card-play-button" data-uri="${playlist.uri}">
                                                <svg class="play-icon-large" viewBox="0 0 24 24">
                                                    <path d="M8 5v14l11-7z"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="card-title">${playlist.name}</div>
                                        <div class="card-subtitle">Playlist</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Update gradient
            document.querySelector('.main-view').style.background = 
                'linear-gradient(to bottom, #535353 0, #121212 250px)';
                
            // Add home search bar functionality
            const homeSearchInput = document.getElementById('homeSearchInput');
            if (homeSearchInput) {
                // Focus on search when clicked
                homeSearchInput.addEventListener('focus', () => {
                    currentSearchInput = homeSearchInput;
                    document.getElementById('keyboard').classList.add('active');
                });
                
                // Handle typing in home search
                homeSearchInput.addEventListener('input', (e) => {
                    const query = e.target.value;
                    
                    if (query.length > 0) {
                        // Debounce search
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            // Switch to search view with results
                            showSearchView();
                            const searchInput = document.getElementById('searchInput');
                            if (searchInput) {
                                searchInput.value = query;
                                performSearch(query);
                            }
                        }, 500);
                    }
                });
            }
        }

        let searchTimeout = null;
        let currentSearchInput = null;

        function showSearchView() {
            document.getElementById('mainContent').innerHTML = `
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"/>
                        </svg>
                        <input type="text" 
                               class="search-input" 
                               id="searchInput" 
                               placeholder="What do you want to listen to?"
                               autocomplete="off">
                        <button class="search-clear" id="searchClear">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12 10.586L6.707 5.293a1 1 0 00-1.414 1.414L10.586 12l-5.293 5.293a1 1 0 001.414 1.414L12 13.414l5.293 5.293a1 1 0 001.414-1.414L13.414 12l5.293-5.293a1 1 0 00-1.414-1.414L12 10.586z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>
            `;

            // Update gradient
            document.querySelector('.main-view').style.background = 
                'linear-gradient(to bottom, #121212 0, #121212 100%)';

            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            const keyboard = document.getElementById('keyboard');
            
            currentSearchInput = searchInput;

            // Show keyboard when input is focused
            searchInput.addEventListener('focus', () => {
                keyboard.classList.add('active');
            });

            // Handle search input
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                
                if (query) {
                    searchClear.classList.add('visible');
                } else {
                    searchClear.classList.remove('visible');
                    document.getElementById('searchResults').innerHTML = '';
                    return;
                }

                // Debounce search
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 500);
            });

            // Clear button
            searchClear.addEventListener('click', () => {
                searchInput.value = '';
                searchClear.classList.remove('visible');
                document.getElementById('searchResults').innerHTML = '';
                searchInput.focus();
            });
        }

        async function performSearch(query) {
            try {
                console.log('Searching for:', query);
                const response = await fetch('http://localhost:5000/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query,
                        // Only search for music content, no podcasts/shows/videos
                        types: ['track', 'album', 'artist', 'playlist']
                    })
                });

                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('Search response:', data);
                
                if (!data.results) {
                    console.error('No results field in response');
                    displaySearchResults([]);
                    return;
                }
                
                // Filter out any podcasts, shows, or audiobooks that might slip through
                const filteredResults = data.results.filter(item => {
                    // Exclude podcast episodes, shows, and audiobooks
                    if (item.type === 'show' || item.type === 'episode' || item.type === 'audiobook') {
                        return false;
                    }
                    // For tracks, check if they're from a podcast show
                    if (item.type === 'track' && item.show_name) {
                        return false;
                    }
                    return true;
                });

                console.log('Filtered results:', filteredResults);
                displaySearchResults(filteredResults);
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchResults').innerHTML = 
                    `<div style="text-align: center; color: var(--text-secondary); padding: 48px;">Search failed: ${error.message}</div>`;
            }
        }

        function displaySearchResults(results) {
            if (!results || results.length === 0) {
                document.getElementById('searchResults').innerHTML = 
                    '<div style="text-align: center; color: var(--text-secondary); padding: 48px;">No results found</div>';
                return;
            }

            // Group results by type
            const grouped = {};
            results.forEach(item => {
                if (!grouped[item.type]) grouped[item.type] = [];
                grouped[item.type].push(item);
            });

            let html = '';

            // Display tracks first
            if (grouped.track) {
                html += `
                    <div class="search-section">
                        <h2 class="search-section-title">Songs</h2>
                        <div class="track-list">
                            <div class="track-list-header">
                                <div style="grid-column: index;">#</div>
                                <div style="grid-column: title;">Title</div>
                                <div style="grid-column: album;">Album</div>
                                <div style="grid-column: duration;">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 3.999a4 4 0 100 8 4 4 0 000-8zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"/>
                                        <path d="M8 8.25H6.25V5.5h1.5V7h.75v1.25z"/>
                                    </svg>
                                </div>
                            </div>
                            ${grouped.track.slice(0, 10).map((track, index) => `
                                <div class="track-row" data-uri="${track.uri}">
                                    <div class="track-index">${index + 1}</div>
                                    <div class="track-title-group">
                                        ${track.image ? `
                                            <div class="track-image">
                                                <img src="${track.image}" alt="">
                                            </div>
                                        ` : ''}
                                        <div class="track-title-info">
                                            <div class="track-title">${track.name}</div>
                                            <div class="track-artists">${track.artist}</div>
                                        </div>
                                    </div>
                                    <div class="track-album">${track.album || ''}</div>
                                    <div class="track-duration">${track.duration || ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Display artists
            if (grouped.artist) {
                html += `
                    <div class="search-section">
                        <h2 class="search-section-title">Artists</h2>
                        <div class="search-grid">
                            ${grouped.artist.slice(0, 6).map(artist => `
                                <div class="search-item" data-type="artist" data-id="${artist.id}">
                                    <div class="search-item-image artist">
                                        ${artist.image ? 
                                            `<img src="${artist.image}" alt="${artist.name}">` :
                                            '<div style="width:100%;height:100%;background:var(--border-color);"></div>'
                                        }
                                    </div>
                                    <div class="search-item-name">${artist.name}</div>
                                    <div class="search-item-type">Artist</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Display albums
            if (grouped.album) {
                html += `
                    <div class="search-section">
                        <h2 class="search-section-title">Albums</h2>
                        <div class="search-grid">
                            ${grouped.album.slice(0, 6).map(album => `
                                <div class="search-item" data-type="album" data-id="${album.id}">
                                    <div class="search-item-image">
                                        ${album.image ? 
                                            `<img src="${album.image}" alt="${album.name}">` :
                                            '<div style="width:100%;height:100%;background:var(--border-color);"></div>'
                                        }
                                    </div>
                                    <div class="search-item-name">${album.name}</div>
                                    <div class="search-item-type">${album.artist}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Display playlists
            if (grouped.playlist) {
                html += `
                    <div class="search-section">
                        <h2 class="search-section-title">Playlists</h2>
                        <div class="search-grid">
                            ${grouped.playlist.slice(0, 6).map(playlist => `
                                <div class="search-item" data-type="playlist" data-id="${playlist.id}">
                                    <div class="search-item-image">
                                        ${playlist.image ? 
                                            `<img src="${playlist.image}" alt="${playlist.name}">` :
                                            '<div style="width:100%;height:100%;background:var(--border-color);"></div>'
                                        }
                                    </div>
                                    <div class="search-item-name">${playlist.name}</div>
                                    <div class="search-item-type">Playlist</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('searchResults').innerHTML = html;
        }

        async function showPlaylistView(playlistId) {
            try {
                const res = await fetch(`http://localhost:5000/api/playlist/${playlistId}`);
                const playlist = await res.json();
                state.currentPlaylist = playlist;
                state.currentPlaylist.id = playlistId;
                
                const isLikedSongs = playlistId === 'liked-songs';
                
                // Generate dominant color or use default
                const bgColor = '#535353';
                document.querySelector('.main-view').style.background = 
                    `linear-gradient(to bottom, ${bgColor} 0, #121212 400px)`;
                
                document.getElementById('mainContent').innerHTML = `
                    <div class="playlist-view">
                        <div class="playlist-header-bg">
                            <div class="playlist-header-content">
                                <div class="playlist-artwork">
                                    ${isLikedSongs ? 
                                        `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #450af5, #c4efd9); display: flex; align-items: center; justify-content: center;">
                                            <svg width="80" height="80" viewBox="0 0 24 24" fill="#fff">
                                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                            </svg>
                                        </div>` :
                                        (playlist.image ? 
                                            `<img src="${playlist.image}" alt="">` : 
                                            '')
                                    }
                                </div>
                                <div class="playlist-details">
                                    <div class="playlist-label">Playlist</div>
                                    <h1 class="playlist-title">${playlist.name}</h1>
                                    <div class="playlist-stats">
                                        <span>${playlist.tracks?.length || 0} songs</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="playlist-controls">
                            <button class="btn-play-large" data-uri="${playlist.uri || 'spotify:playlist:' + playlistId}">
                                <svg class="play-icon-large" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="track-list">
                            <div class="track-list-header">
                                <div style="grid-column: index;">#</div>
                                <div style="grid-column: title;">Title</div>
                                <div style="grid-column: album;">Album</div>
                                <div style="grid-column: duration;">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 3.999a4 4 0 100 8 4 4 0 000-8zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"/>
                                        <path d="M8 8.25H6.25V5.5h1.5V7h.75v1.25z"/>
                                    </svg>
                                </div>
                            </div>
                            ${playlist.tracks?.map((track, i) => `
                                <div class="track-row" data-uri="${track.uri}" data-playlist="${playlistId}" data-offset="${i}">
                                    <div class="track-index">${i + 1}</div>
                                    <div class="track-title-group">
                                        <div class="track-image">
                                            ${track.image ? `<img src="${track.image}" alt="">` : ''}
                                        </div>
                                        <div class="track-title-info">
                                            <div class="track-title">${track.name}</div>
                                            <div class="track-artists">${track.artists}</div>
                                        </div>
                                    </div>
                                    <div class="track-album">${track.album || ''}</div>
                                    <div class="track-duration">${formatDuration(track.duration_ms)}</div>
                                </div>
                            `).join('') || '<div style="padding: 32px; color: var(--text-secondary);">No tracks in this playlist</div>'}
                        </div>
                    </div>
                `;
                
                // Update active playlist
                document.querySelectorAll('.playlist-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.id === playlistId);
                });
            } catch (error) {
                console.error('Failed to load playlist:', error);
            }
        }

        async function playContext(uri) {
            if (!state.deviceId) return;
            
            try {
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${state.deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        context_uri: uri
                    })
                });
            } catch (error) {
                console.error('Failed to play:', error);
            }
        }

        async function playTrack(uri, playlistId, offset) {
            if (!state.deviceId) return;
            
            try {
                const res = await fetch(`http://localhost:5000/api/playlist/${playlistId}`);
                const data = await res.json();
                const uris = data.tracks.map(t => t.uri);
                
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${state.deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: uris,
                        offset: { position: parseInt(offset) }
                    })
                });
            } catch (error) {
                console.error('Failed to play track:', error);
            }
        }

        function updateNowPlaying(playerState) {
            const track = playerState.track_window.current_track;
            if (!track) return;
            
            // Store current track in state
            state.currentTrack = track;
            
            document.getElementById('nowPlayingTitle').textContent = track.name;
            document.getElementById('nowPlayingArtist').textContent = track.artists.map(a => a.name).join(', ');
            
            const cover = document.getElementById('nowPlayingCover');
            if (track.album.images[0]) {
                cover.innerHTML = `<img src="${track.album.images[0].url}" alt="">`;
            }
            
            // Update playing track highlight
            document.querySelectorAll('.track-row').forEach(row => {
                row.classList.toggle('playing', row.dataset.uri === track.uri);
            });
        }

        function updatePlayButton(isPaused) {
            const btn = document.getElementById('playPauseBtn');
            btn.innerHTML = isPaused ? 
                '<svg class="play-icon" viewBox="0 0 16 16"><path d="M3 1.713a.7.7 0 011.05-.607l10.89 6.288a.7.7 0 010 1.212L4.05 14.894A.7.7 0 013 14.288V1.713z"/></svg>' :
                '<svg class="play-icon" viewBox="0 0 16 16"><path d="M2.7 1a.7.7 0 00-.7.7v12.6a.7.7 0 00.7.7h2.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7H2.7zm8 0a.7.7 0 00-.7.7v12.6a.7.7 0 00.7.7h2.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-2.6z"/></svg>';
        }


        function updateProgress(position, duration) {
            const percent = duration > 0 ? (position / duration) * 100 : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('currentTime').textContent = formatTime(position);
            document.getElementById('totalTime').textContent = formatTime(duration);
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            return formatTime(ms);
        }

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 18) return 'Good afternoon';
            return 'Good evening';
        }

        // Initialize Keyboard
        function initializeKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const keyboardClose = document.getElementById('keyboardClose');
            let shiftActive = false;

            // Close keyboard button
            keyboardClose.addEventListener('click', () => {
                keyboard.classList.remove('active');
            });

            // Handle all keyboard keys
            document.querySelectorAll('.keyboard-key').forEach(key => {
                key.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const keyValue = key.dataset.key;
                    
                    if (!currentSearchInput) return;

                    if (keyValue === 'backspace') {
                        currentSearchInput.value = currentSearchInput.value.slice(0, -1);
                        currentSearchInput.dispatchEvent(new Event('input'));
                    } else if (keyValue === 'enter') {
                        // Force immediate search if there's a value
                        if (currentSearchInput && currentSearchInput.value.trim()) {
                            clearTimeout(searchTimeout); // Cancel any pending search
                            performSearch(currentSearchInput.value.trim());
                            // Close keyboard after a brief delay for visual feedback
                            setTimeout(() => {
                                keyboard.classList.remove('active');
                            }, 100);
                        } else {
                            // If no search text, just close the keyboard
                            keyboard.classList.remove('active');
                        }
                    } else if (keyValue === 'shift') {
                        shiftActive = !shiftActive;
                        key.classList.toggle('active', shiftActive);
                        
                        // Update all letter keys
                        document.querySelectorAll('.keyboard-key').forEach(k => {
                            const kValue = k.dataset.key;
                            if (kValue && kValue.length === 1 && /[a-z]/.test(kValue)) {
                                k.textContent = shiftActive ? kValue.toUpperCase() : kValue.toLowerCase();
                                k.dataset.key = shiftActive ? kValue.toUpperCase() : kValue.toLowerCase();
                            }
                        });
                    } else {
                        // Add the character
                        const char = shiftActive && keyValue.length === 1 ? keyValue.toUpperCase() : keyValue;
                        currentSearchInput.value += char;
                        currentSearchInput.dispatchEvent(new Event('input'));
                        
                        // Auto-disable shift after typing a letter
                        if (shiftActive && keyValue.length === 1 && /[a-zA-Z]/.test(keyValue)) {
                            shiftActive = false;
                            document.querySelector('.keyboard-key.shift').classList.remove('active');
                            
                            // Reset all letter keys to lowercase
                            document.querySelectorAll('.keyboard-key').forEach(k => {
                                const kValue = k.dataset.key;
                                if (kValue && kValue.length === 1 && /[A-Z]/.test(kValue)) {
                                    k.textContent = kValue.toLowerCase();
                                    k.dataset.key = kValue.toLowerCase();
                                }
                            });
                        }
                    }
                    
                    // Keep focus on input
                    currentSearchInput.focus();
                });
            });
        }

        // Initialize UI
        function initializeUI() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    const view = e.currentTarget.dataset.view;
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    // Hide keyboard when switching views
                    document.getElementById('keyboard').classList.remove('active');
                    
                    if (view === 'home') {
                        showHomeView();
                    } else if (view === 'search') {
                        showSearchView();
                    }
                });
            });

            // Keyboard functionality
            initializeKeyboard();
            
            // Playlist clicks
            document.addEventListener('click', (e) => {
                // Playlist item click
                if (e.target.closest('.playlist-item')) {
                    const playlistId = e.target.closest('.playlist-item').dataset.id;
                    showPlaylistView(playlistId);
                }
                
                // Quick card click
                if (e.target.closest('.quick-card') && !e.target.closest('.quick-card-play')) {
                    const playlistId = e.target.closest('.quick-card').dataset.id;
                    showPlaylistView(playlistId);
                }
                
                // Card click
                if (e.target.closest('.card') && !e.target.closest('.card-play-button')) {
                    const playlistId = e.target.closest('.card').dataset.id;
                    showPlaylistView(playlistId);
                }
                
                // Play buttons
                if (e.target.closest('.quick-card-play, .card-play-button, .btn-play-large')) {
                    const uri = e.target.closest('[data-uri]').dataset.uri;
                    playContext(uri);
                    e.stopPropagation();
                }
                
                // Track click
                if (e.target.closest('.track-row')) {
                    const row = e.target.closest('.track-row');
                    playTrack(row.dataset.uri, row.dataset.playlist, row.dataset.offset);
                }
                
                // Search result clicks
                if (e.target.closest('.search-item')) {
                    const item = e.target.closest('.search-item');
                    const type = item.dataset.type;
                    const id = item.dataset.id;
                    
                    if (type === 'playlist') {
                        showPlaylistView(id);
                    } else if (type === 'album') {
                        // For now, treat albums like playlists
                        showPlaylistView(id);
                    } else if (type === 'artist') {
                        // Could show artist view in future
                        console.log('Artist clicked:', id);
                    }
                }
            });
            
            // Playback controls
            document.getElementById('playPauseBtn').onclick = () => {
                if (state.player) state.player.togglePlay();
            };
            
            // Album art click - show expanded view
            document.getElementById('nowPlayingCover').addEventListener('click', () => {
                const expanded = document.getElementById('expandedNowPlaying');
                const overlay = document.getElementById('expandedOverlay');
                if (state.currentTrack) {
                    // Update expanded view content
                    const artwork = document.getElementById('expandedArtwork');
                    const title = document.getElementById('expandedTitle');
                    const artist = document.getElementById('expandedArtist');
                    
                    if (state.currentTrack.album.images[0]) {
                        artwork.innerHTML = `<img src="${state.currentTrack.album.images[0].url}" alt="">`;
                    }
                    title.textContent = state.currentTrack.name;
                    artist.textContent = state.currentTrack.artists.map(a => a.name).join(', ');
                    
                    // Show expanded view and overlay
                    expanded.classList.add('active');
                    overlay.classList.add('active');
                }
            });
            
            // Close expanded view
            function closeExpandedView() {
                document.getElementById('expandedNowPlaying').classList.remove('active');
                document.getElementById('expandedOverlay').classList.remove('active');
            }
            
            document.getElementById('expandedClose').addEventListener('click', closeExpandedView);
            document.getElementById('expandedOverlay').addEventListener('click', closeExpandedView);
            
            // Expanded view actions
            document.getElementById('startRadio').addEventListener('click', async () => {
                if (state.currentTrack && state.token) {
                    // Start radio based on current track
                    console.log('Starting radio for:', state.currentTrack.name);
                    closeExpandedView();
                    // API call would go here
                }
            });
            
            document.getElementById('goToArtist').addEventListener('click', () => {
                if (state.currentTrack) {
                    console.log('Going to artist:', state.currentTrack.artists[0].name);
                    closeExpandedView();
                    // Navigate to artist view
                }
            });
            
            document.getElementById('goToAlbum').addEventListener('click', () => {
                if (state.currentTrack) {
                    console.log('Going to album:', state.currentTrack.album.name);
                    closeExpandedView();
                    // Navigate to album view
                }
            });
            
            document.getElementById('addToPlaylist').addEventListener('click', () => {
                if (state.currentTrack) {
                    console.log('Adding to playlist:', state.currentTrack.name);
                    closeExpandedView();
                    // Show playlist selector
                }
            });
            
            document.getElementById('showCredits').addEventListener('click', () => {
                if (state.currentTrack) {
                    console.log('Showing credits for:', state.currentTrack.name);
                    closeExpandedView();
                    // Show credits view
                }
            });
            
            document.getElementById('prevBtn').onclick = () => {
                if (state.player) state.player.previousTrack();
            };
            
            document.getElementById('nextBtn').onclick = () => {
                if (state.player) state.player.nextTrack();
            };
            
            // Progress bar
            setupProgressBar();
            
            // Volume control
            setupVolumeControl();
            
            // Update progress periodically
            setInterval(() => {
                if (state.player) {
                    state.player.getCurrentState().then(playerState => {
                        if (playerState && !playerState.paused) {
                            updateProgress(playerState.position, playerState.duration);
                        }
                    });
                }
            }, 1000);
        }

        function setupProgressBar() {
            const progressBar = document.getElementById('progressBar');
            let isDragging = false;
            
            function updateSeek(e) {
                if (!state.player) return;
                const rect = progressBar.getBoundingClientRect();
                const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                state.player.getCurrentState().then(playerState => {
                    if (playerState) {
                        state.player.seek(percent * playerState.duration);
                    }
                });
            }
            
            progressBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateSeek(e);
            });
            
            progressBar.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                updateSeek({ clientX: touch.clientX });
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateSeek(e);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    updateSeek({ clientX: touch.clientX });
                }
            });
            
            document.addEventListener('mouseup', () => isDragging = false);
            document.addEventListener('touchend', () => isDragging = false);
        }

        function setupVolumeControl() {
            const volumeBar = document.getElementById('volumeBar');
            const volumeFill = document.getElementById('volumeFill');
            const volumeBtn = document.getElementById('volumeBtn');
            let isDragging = false;
            
            function updateVolume(e) {
                if (!state.player) return;
                const rect = volumeBar.getBoundingClientRect();
                const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                state.volume = percent;
                state.player.setVolume(percent);
                volumeFill.style.width = (percent * 100) + '%';
                updateVolumeIcon();
            }
            
            function updateVolumeIcon() {
                const icon = volumeBtn.querySelector('svg');
                if (state.volume === 0) {
                    // Muted icon
                    icon.innerHTML = '<path fill="currentColor" d="M10.188 1.093a.75.75 0 0 1 .718.747v12.32a.75.75 0 0 1-1.218.585L5.426 11H2.25A1.25 1.25 0 0 1 1 9.75v-3.5C1 5.56 1.56 5 2.25 5h3.176l4.262-3.745a.75.75 0 0 1 .5-.162zM9.438 2.802 6.172 5.676A.75.75 0 0 1 5.676 5.5H2.25v4h3.426a.75.75 0 0 1 .496.188l3.266 2.874V2.802z"/><path fill="currentColor" d="M13.28 5.22a.75.75 0 0 1 1.06 1.06L12.56 8l1.78 1.72a.75.75 0 1 1-1.06 1.06L11.5 9l-1.78 1.78a.75.75 0 0 1-1.06-1.06L10.44 8 8.66 6.28a.75.75 0 0 1 1.06-1.06L11.5 7l1.78-1.78z"/>';
                } else if (state.volume < 0.5) {
                    // Low volume icon
                    icon.innerHTML = '<path fill="currentColor" d="M10.188 1.093a.75.75 0 0 1 .718.747v12.32a.75.75 0 0 1-1.218.585L5.426 11H2.25A1.25 1.25 0 0 1 1 9.75v-3.5C1 5.56 1.56 5 2.25 5h3.176l4.262-3.745a.75.75 0 0 1 .5-.162zM9.438 2.802 6.172 5.676A.75.75 0 0 1 5.676 5.5H2.25v4h3.426a.75.75 0 0 1 .496.188l3.266 2.874V2.802z"/><path fill="currentColor" d="M11.5 5.174a2.75 2.75 0 0 1 0 5.652v-1.55a1.25 1.25 0 0 0 0-2.552v-1.55z"/>';
                } else {
                    // High volume icon  
                    icon.innerHTML = '<path fill="currentColor" d="M10.188 1.093a.75.75 0 0 1 .718.747v12.32a.75.75 0 0 1-1.218.585L5.426 11H2.25A1.25 1.25 0 0 1 1 9.75v-3.5C1 5.56 1.56 5 2.25 5h3.176l4.262-3.745a.75.75 0 0 1 .5-.162zM9.438 2.802 6.172 5.676A.75.75 0 0 1 5.676 5.5H2.25v4h3.426a.75.75 0 0 1 .496.188l3.266 2.874V2.802z"/><path fill="currentColor" d="M11.5 5.174a2.75 2.75 0 0 1 0 5.652v-1.55a1.25 1.25 0 0 0 0-2.552v-1.55zm0-2.424a5.25 5.25 0 0 1 0 10.5v-1.55a3.75 3.75 0 0 0 0-7.4v-1.55z"/>';
                }
            }
            
            volumeBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateVolume(e);
            });
            
            volumeBar.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                updateVolume({ clientX: touch.clientX });
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateVolume(e);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    updateVolume({ clientX: touch.clientX });
                }
            });
            
            document.addEventListener('mouseup', () => isDragging = false);
            document.addEventListener('touchend', () => isDragging = false);
            
            volumeBtn.addEventListener('click', () => {
                if (state.volume > 0) {
                    state.player.setVolume(0);
                    state.volume = 0;
                    volumeFill.style.width = '0%';
                } else {
                    state.player.setVolume(0.5);
                    state.volume = 0.5;
                    volumeFill.style.width = '50%';
                }
                updateVolumeIcon();
            });
        }
    </script>

    <!-- On-screen Keyboard -->
    <div class="keyboard-container" id="keyboard">
        <button class="keyboard-close" id="keyboardClose"></button>
        <div class="keyboard-row">
            <button class="keyboard-key" data-key="1">1</button>
            <button class="keyboard-key" data-key="2">2</button>
            <button class="keyboard-key" data-key="3">3</button>
            <button class="keyboard-key" data-key="4">4</button>
            <button class="keyboard-key" data-key="5">5</button>
            <button class="keyboard-key" data-key="6">6</button>
            <button class="keyboard-key" data-key="7">7</button>
            <button class="keyboard-key" data-key="8">8</button>
            <button class="keyboard-key" data-key="9">9</button>
            <button class="keyboard-key" data-key="0">0</button>
            <button class="keyboard-key backspace" data-key="backspace"></button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key" data-key="q">q</button>
            <button class="keyboard-key" data-key="w">w</button>
            <button class="keyboard-key" data-key="e">e</button>
            <button class="keyboard-key" data-key="r">r</button>
            <button class="keyboard-key" data-key="t">t</button>
            <button class="keyboard-key" data-key="y">y</button>
            <button class="keyboard-key" data-key="u">u</button>
            <button class="keyboard-key" data-key="i">i</button>
            <button class="keyboard-key" data-key="o">o</button>
            <button class="keyboard-key" data-key="p">p</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key" data-key="a">a</button>
            <button class="keyboard-key" data-key="s">s</button>
            <button class="keyboard-key" data-key="d">d</button>
            <button class="keyboard-key" data-key="f">f</button>
            <button class="keyboard-key" data-key="g">g</button>
            <button class="keyboard-key" data-key="h">h</button>
            <button class="keyboard-key" data-key="j">j</button>
            <button class="keyboard-key" data-key="k">k</button>
            <button class="keyboard-key" data-key="l">l</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key shift" data-key="shift">Shift</button>
            <button class="keyboard-key" data-key="z">z</button>
            <button class="keyboard-key" data-key="x">x</button>
            <button class="keyboard-key" data-key="c">c</button>
            <button class="keyboard-key" data-key="v">v</button>
            <button class="keyboard-key" data-key="b">b</button>
            <button class="keyboard-key" data-key="n">n</button>
            <button class="keyboard-key" data-key="m">m</button>
            <button class="keyboard-key enter" data-key="enter">Enter</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key space" data-key=" ">Space</button>
        </div>
    </div>
</body>
</html>